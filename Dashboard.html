<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: 'Inter', sans-serif; }
.page { display: none; }
.page.active { display: block; }
body::-webkit-scrollbar { display: none; }
body { -ms-overflow-style: none; scrollbar-width: none; }
.tab-image { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; }
</style>
</head>
<body class="bg-gray-100 text-gray-900">

<!-- Loading Spinner -->
<div id="loading-container" class="flex items-center justify-center min-h-screen bg-gray-100">
  <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>
</div>

<!-- Login / Register -->
<div id="login-page" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 hidden">
  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
    <h2 class="text-2xl font-bold text-gray-800 mb-6" id="login-title">Login</h2>
    <div class="space-y-4">
      <input type="email" id="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg">
      <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg">
      <select id="role-select" class="w-full px-4 py-2 border rounded-lg">
        <option value="manager">Manager</option>
        <option value="assistant">Shop Assistant</option>
      </select>
      <button id="auth-btn" class="w-full py-3 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">Login</button>
      <p class="text-sm text-gray-500">Or <span id="toggle-auth" class="text-indigo-600 cursor-pointer">Register</span></p>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div id="main-dashboard-container" class="flex min-h-screen hidden">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 p-6 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:flex lg:flex-col">
    <div class="flex items-center justify-between lg:justify-start mb-10">
      <h1 class="text-2xl font-bold text-indigo-600">Grocery Admin</h1>
      <button id="sidebar-close-btn" class="p-2 text-gray-700 lg:hidden"><i data-lucide="x" class="w-6 h-6"></i></button>
    </div>
    <nav id="nav-container" class="space-y-2 flex-grow"></nav>
    <div class="mt-8 pt-4 border-t border-gray-200">
      <button id="logout-btn" class="w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto">
    <button id="sidebar-open-btn" class="fixed top-4 left-4 z-50 p-2 text-gray-700 bg-white rounded-lg shadow-md lg:hidden">
      <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Dashboard Pages -->
    <div id="dashboard" class="page">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>
      <div id="dashboard-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </div>

    <div id="products" class="page">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Products</h2>
        <button id="add-product-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Add New Product</button>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <table class="w-full text-left table-auto">
          <thead>
            <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
              <th class="py-3 px-6">Product</th>
              <th class="py-3 px-6">Category</th>
              <th class="py-3 px-6">Stock</th>
              <th class="py-3 px-6">Price</th>
              <th class="py-3 px-6">Unit</th>
              <th class="py-3 px-6">Rating</th>
              <th class="py-3 px-6">Actions</th>
            </tr>
          </thead>
          <tbody id="products-table-body" class="text-gray-600 text-sm font-light"></tbody>
        </table>
      </div>
      <div class="product-grid row grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6" id="productsGridAll"></div>
    </div>

    <div id="sales" class="page">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Process Sale</h2>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <label>Product</label>
        <select id="sale-product" class="w-full p-2 border rounded-lg mb-4"></select>
        <label>Quantity</label>
        <input type="number" id="sale-quantity" class="w-full p-2 border rounded-lg mb-4">
        <button id="confirm-sale" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Confirm Sale</button>
      </div>
      <h3 class="mt-6 text-xl font-bold">Walk-in Customer Registration</h3>
      <input type="text" id="customer-name" placeholder="Name" class="w-full p-2 border rounded-lg mb-2">
      <input type="text" id="customer-phone" placeholder="Phone" class="w-full p-2 border rounded-lg mb-2">
      <button id="register-customer" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors">Register Customer</button>
    </div>

    <div id="reports" class="page">
      <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
      <label>Filter by Product:</label>
      <select id="report-product" class="border px-3 py-2 rounded mb-2 w-full"></select>
      <label>Start Date:</label>
      <input type="date" id="report-start" class="border px-3 py-2 rounded mb-2 w-full">
      <label>End Date:</label>
      <input type="date" id="report-end" class="border px-3 py-2 rounded mb-2 w-full">
      <button id="generate-report" class="bg-indigo-600 text-white px-4 py-2 rounded mb-4">Generate</button>
      <div id="reports-content" class="bg-white p-4 rounded shadow"></div>
    </div>

    <div id="orders" class="page">
      <h2 class="text-2xl font-bold mb-4">Supplier Orders</h2>
      <div id="orders-content" class="bg-white p-4 rounded shadow"></div>
    </div>

    <div id="users" class="page">
      <h2 class="text-2xl font-bold mb-4">Manage Users</h2>
      <input type="email" id="new-user-email" placeholder="New User Email" class="border px-3 py-2 rounded mb-2 w-full">
      <select id="new-user-role" class="border px-3 py-2 rounded mb-2 w-full">
        <option value="manager">Manager</option>
        <option value="assistant">Shop Assistant</option>
      </select>
      <button id="add-user" class="bg-indigo-600 text-white px-4 py-2 rounded mb-4">Add User</button>
      <div id="users-list"></div>
    </div>
  </main>
</div>

<!-- Product Modal -->
<div id="product-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold text-gray-800">Add / Edit Product</h3>
      <button id="product-modal-close" class="text-gray-600 hover:text-gray-900">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </div>
    <div class="space-y-4">
      <input type="text" id="product-name" placeholder="Product Name" class="w-full px-4 py-2 border rounded-lg">
      <select id="product-category" class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Category</option>
        <option value="Fruits">Fruits</option>
        <option value="Vegetables">Vegetables</option>
        <option value="Beverages">Beverages</option>
        <option value="Snacks">Snacks</option>
        <option value="Dairy">Dairy</option>
      </select>
      <input type="number" id="product-stock" placeholder="Stock" class="w-full px-4 py-2 border rounded-lg">
      <select id="product-unit" class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Unit</option>
        <option value="kg">kg</option>
        <option value="g">g</option>
        <option value="liter">liter</option>
        <option value="unit">unit</option>
      </select>
      <input type="number" step="0.01" id="product-price" placeholder="Price" class="w-full px-4 py-2 border rounded-lg">
      <input type="text" id="product-discount" placeholder="Discount" class="w-full px-4 py-2 border rounded-lg">
      <input type="number" id="product-rating" placeholder="Rating (0-5)" min="0" max="5" class="w-full px-4 py-2 border rounded-lg">
      <input type="file" id="product-image" accept="image/*" class="w-full px-4 py-2 border rounded-lg">
    </div>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="product-modal-cancel" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Cancel</button>
      <button id="product-modal-save" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Save</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
  const firebaseConfig = {
    apiKey: "AIzaSyDWH3LoCvRmTUMthsUsIA0MBiqZ4NmFyco",
    authDomain: "ecome-72c36.firebaseapp.com",
    projectId: "ecome-72c36",
    storageBucket: "ecome-72c36.appspot.com",
    messagingSenderId: "880319220349",
    appId: "1:880319220349:web:4af4666ec90587a23dbf14",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loading = document.getElementById('loading-container');
  const loginPage = document.getElementById('login-page');
  const mainDashboard = document.getElementById('main-dashboard-container');
  const authBtn = document.getElementById('auth-btn');
  const toggleAuth = document.getElementById('toggle-auth');
  let isRegister = false;
  let currentRole = '';
  let editingProductId = null;
  const cloudName='dxvjpkrzf';
  const uploadPreset='grocery_products';

  // Toggle login/register
  toggleAuth.addEventListener('click', () => {
    isRegister = !isRegister;
    document.getElementById('login-title').innerText = isRegister?'Register':'Login';
    authBtn.innerText = isRegister?'Register':'Login';
  });

  // Login/Register
  authBtn.addEventListener('click', async ()=>{
    const email=document.getElementById('email').value;
    const password=document.getElementById('password').value;
    const role=document.getElementById('role-select').value;
    try{
      let userCredential;
      if(isRegister){
        userCredential = await auth.createUserWithEmailAndPassword(email,password);
        await db.collection('users').doc(userCredential.user.uid).set({ role, email });
      } else {
        userCredential = await auth.signInWithEmailAndPassword(email,password);
      }
      currentRole=role;
    }catch(err){ alert(err.message);}
  });

  // Auth state
  auth.onAuthStateChanged(async user=>{
    loading.style.display='none';
    if(user){
      loginPage.style.display='none';
      mainDashboard.classList.remove('hidden');
      if(!currentRole){
        const doc=await db.collection('users').doc(user.uid).get();
        currentRole=doc.exists?doc.data().role:'manager';
      }
      setupNav(currentRole);
      loadProducts();
      populateSaleProducts();
      if(currentRole==='manager'){
        loadUsers();
        loadSupplierOrders();
        populateReportProducts();
      }
    } else{
      loginPage.style.display='flex';
      mainDashboard.classList.add('hidden');
    }
  });

  const pages=document.querySelectorAll('.page');
  const navContainer=document.getElementById('nav-container');
  const showPage=(page)=>{ pages.forEach(p=>p.classList.remove('active')); const el=document.getElementById(page.toLowerCase()); if(el)el.classList.add('active'); };

  const roles={
    manager:['dashboard','products','reports','orders','users'],
    assistant:['dashboard','sales']
  };
  const setupNav=(role)=>{
    navContainer.innerHTML='';
    roles[role].forEach(item=>{
      const btn=document.createElement('button');
      btn.textContent=item.charAt(0).toUpperCase()+item.slice(1);
      btn.className='w-full text-left py-2 px-3 rounded hover:bg-gray-100 transition';
      btn.addEventListener('click',()=>showPage(item));
      navContainer.appendChild(btn);
    });
    showPage(roles[role][0]);
  };

  // Sidebar toggle
  const sidebar=document.getElementById('sidebar');
  document.getElementById('sidebar-open-btn').addEventListener('click',()=>sidebar.classList.remove('-translate-x-full'));
  document.getElementById('sidebar-close-btn').addEventListener('click',()=>sidebar.classList.add('-translate-x-full'));

  // Logout
  document.getElementById('logout-btn').addEventListener('click',()=>auth.signOut());

  // Products
  const productModal=document.getElementById('product-modal');
  document.getElementById('add-product-btn').addEventListener('click',()=>{ editingProductId=null; productModal.classList.remove('hidden'); });
  const closeProductModal=()=>productModal.classList.add('hidden');
  document.getElementById('product-modal-close').addEventListener('click',closeProductModal);
  document.getElementById('product-modal-cancel').addEventListener('click',closeProductModal);

  const loadProducts=async()=>{
    const snapshot=await db.collection('products').get();
    const products=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
    renderProducts(products);
  };

  const renderProducts=(products)=>{
    const tbody=document.getElementById('products-table-body');
    const grid=document.getElementById('productsGridAll');
    tbody.innerHTML=''; grid.innerHTML='';
    products.forEach(p=>{
      tbody.innerHTML+=`
        <tr class="border-b border-gray-200 hover:bg-gray-50">
          <td class="py-3 px-6">${p.name}</td>
          <td class="py-3 px-6">${p.category}</td>
          <td class="py-3 px-6">${p.stock}</td>
          <td class="py-3 px-6">R ${parseFloat(p.price).toFixed(2)}</td>
          <td class="py-3 px-6">${p.unit}</td>
          <td class="py-3 px-6">${p.rating}</td>
          <td class="py-3 px-6">
            <button class="text-indigo-600 hover:underline" onclick="editProduct('${p.id}')">Edit</button>
            <button class="text-red-600 hover:underline" onclick="deleteProduct('${p.id}')">Delete</button>
          </td>
        </tr>
      `;
      grid.innerHTML+=`
        <div class="product-item border p-3 rounded-lg relative">
          <span class="badge bg-success absolute top-2 left-2 px-2 py-1 rounded">${p.discount||''}</span>
          <figure><img src="${p.image}" class="tab-image mb-2"></figure>
          <h3 class="font-bold">${p.name}</h3>
          <span class="qty">${p.stock} ${p.unit}</span>
          <span class="rating block">⭐ ${p.rating}</span>
          <span class="price block">R ${parseFloat(p.price).toFixed(2)}</span>
        </div>
      `;
    });
  };

  window.editProduct=async(id)=>{
    editingProductId=id;
    const doc=await db.collection('products').doc(id).get();
    const p=doc.data();
    ['name','category','stock','unit','price','discount','rating'].forEach(f=>{
      document.getElementById(`product-${f}`).value=p[f]||'';
    });
    productModal.classList.remove('hidden');
  };

  window.deleteProduct=async(id)=>{
    await db.collection('products').doc(id).delete();
    loadProducts();
    populateSaleProducts();
    populateReportProducts();
  };

  document.getElementById('product-modal-save').addEventListener('click', async ()=>{
    const name=document.getElementById('product-name').value.trim();
    const category=document.getElementById('product-category').value;
    const stock=parseInt(document.getElementById('product-stock').value);
    const unit=document.getElementById('product-unit').value;
    const price=parseFloat(document.getElementById('product-price').value);
    const discount=document.getElementById('product-discount').value.trim();
    const rating=parseFloat(document.getElementById('product-rating').value);
    const imageInput=document.getElementById('product-image');
    if(!name||!category||isNaN(stock)||!unit||isNaN(price)||isNaN(rating)||(!imageInput.files.length && !editingProductId)){
      alert('Please fill all fields and select image'); return;
    }
    const uploadImageToCloudinary=(file)=>{
      const formData=new FormData();
      formData.append('file',file);
      formData.append('upload_preset',uploadPreset);
      return fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`,{method:'POST',body:formData}).then(res=>res.json());
    };
    let imageUrl=null;
    if(imageInput.files.length){ const res=await uploadImageToCloudinary(imageInput.files[0]); imageUrl=res.secure_url; }
    const data={name,category,stock,unit,price,discount,rating};
    if(imageUrl) data.image=imageUrl;
    if(editingProductId) await db.collection('products').doc(editingProductId).update(data);
    else await db.collection('products').add(data);
    closeProductModal(); loadProducts(); populateSaleProducts(); populateReportProducts();
    ['product-name','product-category','product-stock','product-unit','product-price','product-discount','product-rating','product-image'].forEach(id=>document.getElementById(id).value='');
  });

  // Sales
  const populateSaleProducts=async()=>{
    const snapshot=await db.collection('products').get();
    const saleSelect=document.getElementById('sale-product');
    saleSelect.innerHTML='';
    snapshot.docs.forEach(doc=>{
      const p=doc.data();
      const opt=document.createElement('option');
      opt.value=doc.id; opt.textContent=`${p.name} - R ${p.price}`;
      saleSelect.appendChild(opt);
    });
  };

  document.getElementById('confirm-sale').addEventListener('click',async()=>{
    const productId=document.getElementById('sale-product').value;
    const quantity=parseInt(document.getElementById('sale-quantity').value);
    if(!productId||isNaN(quantity)||quantity<=0){ alert('Select product and quantity'); return; }
    const doc=await db.collection('products').doc(productId).get();
    const product=doc.data();
    if(quantity>product.stock){ alert('Not enough stock'); return; }
    await db.collection('sales').add({ productId, quantity, timestamp:new Date(), userId:auth.currentUser.uid });
    await db.collection('products').doc(productId).update({ stock:product.stock-quantity });
    alert('Sale recorded'); document.getElementById('sale-quantity').value='';
    loadProducts(); populateSaleProducts(); populateReportProducts();
  });

  // Walk-in customer
  document.getElementById('register-customer').addEventListener('click',async()=>{
    const name=document.getElementById('customer-name').value.trim();
    const phone=document.getElementById('customer-phone').value.trim();
    if(!name||!phone){ alert('Fill customer details'); return; }
    await db.collection('customers').add({ name, phone, registeredAt:new Date() });
    alert('Customer registered'); document.getElementById('customer-name').value=''; document.getElementById('customer-phone').value='';
  });

  // Reports
  const populateReportProducts=async()=>{
    const snapshot=await db.collection('products').get();
    const reportSelect=document.getElementById('report-product');
    reportSelect.innerHTML='<option value="">All Products</option>';
    snapshot.docs.forEach(doc=>{
      const p=doc.data(); const opt=document.createElement('option'); opt.value=doc.id; opt.textContent=p.name; reportSelect.appendChild(opt);
    });
  };

  document.getElementById('generate-report').addEventListener('click',async()=>{
    const productId=document.getElementById('report-product').value;
    const start=document.getElementById('report-start').value?new Date(document.getElementById('report-start').value):null;
    const end=document.getElementById('report-end').value?new Date(document.getElementById('report-end').value):null;
    let snapshot=await db.collection('sales').get();
    let sales=snapshot.docs.map(d=>({id:d.id,...d.data()}));
    if(productId) sales=sales.filter(s=>s.productId===productId);
    if(start) sales=sales.filter(s=>s.timestamp.toDate()>=start);
    if(end) sales=sales.filter(s=>s.timestamp.toDate()<=end);
    const content=document.getElementById('reports-content');
    content.innerHTML='<h3 class="font-bold mb-2">Sales</h3>';
    if(sales.length===0){ content.innerHTML+='<p>No sales found</p>'; return; }
    sales.forEach(s=>{
      content.innerHTML+=`<p>${s.productId} - Qty: ${s.quantity} - ${new Date(s.timestamp.toDate()).toLocaleString()}</p>`;
    });
  });

  // Users
  const loadUsers=async()=>{
    const snapshot=await db.collection('users').get();
    const list=document.getElementById('users-list'); list.innerHTML='';
    snapshot.docs.forEach(doc=>{
      const u=doc.data();
      list.innerHTML+=`<div class="flex justify-between p-2 border mb-1 rounded">${u.email} (${u.role}) <button class="text-red-600" onclick="deleteUser('${doc.id}')">Delete</button></div>`;
    });
  };
  document.getElementById('add-user').addEventListener('click',async()=>{
    const email=document.getElementById('new-user-email').value.trim();
    const role=document.getElementById('new-user-role').value;
    if(!email||!role){ alert('Fill details'); return; }
    await db.collection('users').add({ email, role });
    document.getElementById('new-user-email').value=''; loadUsers();
  });
  window.deleteUser=async(id)=>{ await db.collection('users').doc(id).delete(); loadUsers(); };

  // Supplier Orders
  const loadSupplierOrders=async()=>{
    const snapshot=await db.collection('supplierOrders').get();
    const container=document.getElementById('orders-content');
    container.innerHTML='';
    snapshot.docs.forEach(doc=>{
      const o=doc.data();
      container.innerHTML+=`<div class="border p-2 mb-2 rounded">
        <p>Product: ${o.productName} - Qty: ${o.quantity} - Status: ${o.status||'Pending'}</p>
        ${o.status!=='Pending'?'':`<button class="bg-green-600 text-white px-2 py-1 rounded mr-2" onclick="approveOrder('${doc.id}')">Approve</button>
        <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="rejectOrder('${doc.id}')">Reject</button>`}
      </div>`;
    });
  };
  window.approveOrder=async(id)=>{ await db.collection('supplierOrders').doc(id).update({ status:'Approved' }); loadSupplierOrders(); };
  window.rejectOrder=async(id)=>{ await db.collection('supplierOrders').doc(id).update({ status:'Rejected' }); loadSupplierOrders(); };

});
</script>
</body>
</html>
