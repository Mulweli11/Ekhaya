<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: 'Inter', sans-serif; }
.page { display: none; }
.page.active { display: block; }
body::-webkit-scrollbar { display: none; }
body { -ms-overflow-style: none; scrollbar-width: none; }
.tab-image { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; }
.product-item { transition: transform 0.2s; }
.product-item:hover { transform: translateY(-2px); }
.debug-info { background: #f3f4f6; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
</style>
</head>
<body class="bg-gray-100 text-gray-900">

<!-- Login/Register Offcanvas -->
<div class="offcanvas offcanvas-end fixed top-0 right-0 z-50 w-full max-w-md bg-white shadow-xl transform translate-x-full transition-transform duration-300" id="offcanvasLoginRegister" tabindex="-1" aria-labelledby="offcanvasLoginRegisterLabel">
  <div class="offcanvas-header flex justify-center items-center p-4 border-b">
    <h5 class="offcanvas-title text-xl font-bold" id="offcanvasLoginRegisterLabel">Account</h5>
    <button type="button" class="btn-close absolute right-4" data-bs-dismiss="offcanvas" aria-label="Close">
      <i data-lucide="x" class="w-6 h-6"></i>
    </button>
  </div>
  <div class="offcanvas-body p-4">
    <!-- Login Form -->
    <div id="login-form-wrapper" class="p-3">
      <h2 class="text-center text-2xl font-bold mb-4">Log In</h2>
      <form id="login-form">
        <div class="mb-3">
          <label for="login-email" class="form-label block text-sm font-medium text-gray-700 mb-1">Email address</label>
          <input type="email" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md" id="login-email" required>
        </div>
        <div class="mb-3">
          <label for="login-password" class="form-label block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input type="password" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md" id="login-password" required>
        </div>
        <div class="mb-3">
          <label for="login-role" class="form-label block text-sm font-medium text-gray-700 mb-1">Role</label>
          <select id="login-role" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="manager">Manager</option>
            <option value="assistant">Shop Assistant</option>
            <option value="customer">Customer</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Log In</button>
      </form>
      <div class="text-center mt-3">
        <p class="mb-1 text-sm text-gray-600">Forgot your password?</p>
        <button id="forgot-password-btn" class="btn btn-link text-indigo-600 text-sm">Reset Password</button>
      </div>
      <div class="text-center mt-3">
        <p class="mb-1 text-sm text-gray-600">Don't have an account?</p>
        <button class="btn btn-link text-indigo-600 text-sm toggle-btn" data-target="register-form-wrapper">Register here</button>
      </div>
    </div>

    <!-- Registration Form -->
    <div id="register-form-wrapper" class="p-3 hidden">
      <h2 class="text-center text-2xl font-bold mb-4">Register</h2>
      <form id="register-form">
        <div class="mb-3">
          <label for="register-name" class="form-label block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input type="text" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md" id="register-name" required>
        </div>
        <div class="mb-3">
          <label for="register-email" class="form-label block text-sm font-medium text-gray-700 mb-1">Email address</label>
          <input type="email" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md" id="register-email" required>
        </div>
        <div class="mb-3">
          <label for="register-role" class="form-label block text-sm font-medium text-gray-700 mb-1">Role</label>
          <select id="register-role" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="customer">Customer</option>
            <option value="manager">Manager</option>
            <option value="assistant">Shop Assistant</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="register-password" class="form-label block text-sm font-medium text-gray-700 mb-1">Password</label>
          <div class="input-group flex">
            <input type="password" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md rounded-r-none" id="register-password" required>
            <button class="btn btn-outline-secondary bg-gray-100 border border-gray-300 border-l-0 px-3 py-2 rounded-r-md" type="button" id="generate-password-btn">Generate Password ‚ú®</button>
          </div>
          <div id="password-feedback" class="form-text text-sm text-gray-500 mt-1"></div>
        </div>
        <div class="mb-3">
          <label for="register-password-confirm" class="form-label block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
          <input type="password" class="form-control w-full px-3 py-2 border border-gray-300 rounded-md" id="register-password-confirm" required>
        </div>
        <button type="submit" class="btn btn-success w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Register</button>
      </form>
      <div class="text-center mt-3">
        <p class="mb-1 text-sm text-gray-600">Already have an account?</p>
        <button class="btn btn-link text-indigo-600 text-sm toggle-btn" data-target="login-form-wrapper">Log in here</button>
      </div>
    </div>

    <!-- Logged In Page -->
    <div id="logged-in-wrapper" class="p-3 hidden text-center">
      <h2 class="mb-4 text-xl font-bold">Welcome, <span id="user-name-display"></span>!</h2>
      <p class="text-gray-600">You have successfully logged in.</p>
      <button id="logout-btn" class="btn btn-danger w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 mt-4">Log Out</button>
    </div>
  </div>
</div>

<!-- Main Dashboard Container -->
<div id="main-dashboard-container" class="flex min-h-screen hidden">
  <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 p-6 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:flex lg:flex-col">
    <div class="flex items-center justify-between lg:justify-start mb-10">
      <h1 class="text-2xl font-bold text-indigo-600">Grocery Admin</h1>
      <button id="sidebar-close-btn" class="p-2 text-gray-700 lg:hidden"><i data-lucide="x" class="w-6 h-6"></i></button>
    </div>
    <nav id="nav-container" class="space-y-2 flex-grow"></nav>
    <div class="mt-8 pt-4 border-t border-gray-200">
      <button id="dashboard-logout-btn" class="w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
      </button>
    </div>
  </aside>

  <main class="flex-1 p-8 overflow-y-auto">
    <button id="sidebar-open-btn" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-2 text-gray-700 bg-white rounded-lg shadow-md lg:hidden">
      <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Dashboard Content -->
    <div id="dashboard" class="page active">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>
      <div id="dashboard-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Metrics will be loaded here -->
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg" id="dashboard-chart-area">
        <!-- Chart will be loaded here -->
      </div>
    </div>

    <div id="products" class="page">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Products</h2>
        <button id="add-product-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Add New Product</button>
      </div>

      <div class="flex flex-wrap items-center justify-between gap-4 mb-6 bg-white p-4 rounded-xl shadow-lg">
        <div>
          <label for="product-category-filter" class="font-medium text-gray-700 mr-2">Filter by Category:</label>
          <select id="product-category-filter" class="border px-3 py-2 rounded-lg">
            <option value="All">All Categories</option>
            <option value="Fruits">Fruits</option>
            <option value="Vegetables">Vegetables</option>
            <option value="Beverages">Beverages</option>
            <option value="Snacks">Snacks</option>
            <option value="Dairy">Dairy</option>
            <option value="Meat">Meat</option>
          </select>
        </div>
        <div>
          <label for="product-sort" class="font-medium text-gray-700 mr-2">Sort by:</label>
          <select id="product-sort" class="border px-3 py-2 rounded-lg">
            <option value="name_asc">Name (A-Z)</option>
            <option value="name_desc">Name (Z-A)</option>
            <option value="price_asc">Price (Low to High)</option>
            <option value="price_desc">Price (High to Low)</option>
            <option value="stock_desc">Stock (High to Low)</option>
          </select>
        </div>
      </div>
      
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6 overflow-x-auto">
        <table class="w-full text-left table-auto min-w-max">
          <thead>
            <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
              <th class="py-3 px-6">Product</th>
              <th class="py-3 px-6">Category</th>
              <th class="py-3 px-6">Stock</th>
              <th class="py-3 px-6">Price</th>
              <th class="py-3 px-6">Unit</th>
              <th class="py-3 px-6">Rating</th>
              <th class="py-3 px-6">Actions</th>
            </tr>
          </thead>
          <tbody id="products-table-body" class="text-gray-600 text-sm font-light"></tbody>
        </table>
      </div>
      <div class="product-grid row grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4" id="productsGridAll"></div>
    </div>

    <div id="sales" class="page">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Process Sale</h2>
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <label class="block font-medium mb-1">Product</label>
        <select id="sale-product" class="w-full p-2 border rounded-lg mb-4"></select>
        <label class="block font-medium mb-1">Quantity</label>
        <input type="number" id="sale-quantity" class="w-full p-2 border rounded-lg mb-4" placeholder="Enter quantity to sell">
        <button id="confirm-sale" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Confirm Sale</button>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="mt-1 text-xl font-bold mb-4">Walk-in Customer Registration</h3>
        <input type="text" id="customer-name" placeholder="Name" class="w-full p-2 border rounded-lg mb-2">
        <input type="text" id="customer-phone" placeholder="Phone" class="w-full p-2 border rounded-lg mb-4">
        <button id="register-customer" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors">Register Customer</button>
        <p class="text-xs mt-2 text-gray-500">This adds a record to the customers list for counting/marketing.</p>
      </div>
    </div>

    <div id="reports" class="page">
      <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <label class="block font-medium mb-1">Filter by Product:</label>
        <select id="report-product" class="border px-3 py-2 rounded mb-4 w-full"></select>
        <label class="block font-medium mb-1">Start Date:</label>
        <input type="date" id="report-start" class="border px-3 py-2 rounded mb-4 w-full">
        <label class="block font-medium mb-1">End Date:</label>
        <input type="date" id="report-end" class="border px-3 py-2 rounded mb-4 w-full">
        <button id="generate-report" class="bg-indigo-600 text-white px-4 py-2 rounded shadow-md hover:bg-indigo-700">Generate Report</button>
      </div>
      <div id="reports-content" class="bg-white p-6 rounded-xl shadow-lg mt-6"></div>
    </div>

        <div id="orders" class="page">
      <h2 class="text-2xl font-bold mb-4">Customer Orders</h2>
      
      <!-- Debug Info -->
      <div id="debug-info" class="debug-info">
        <strong>Debug Information:</strong>
        <button id="hide-debug" class="ml-2 text-sm bg-gray-300 px-2 py-1 rounded">Hide</button>
        <div id="debug-content"></div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">All Customer Orders</h3>
          <div class="flex gap-2">
            <button id="refresh-orders" class="bg-blue-500 text-white px-3 py-2 rounded text-sm hover:bg-blue-600">
              Refresh Orders
            </button>
            <select id="order-status-filter" class="border px-3 py-2 rounded">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="preparing">Preparing</option>
              <option value="out-for-delivery">Out for Delivery</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>
        
        <!-- Orders Counter -->
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
          <strong>Orders Found: <span id="orders-count">0</span></strong>
        </div>
        
        <div id="customer-orders-content" class="space-y-4">
          <!-- Customer orders will be loaded here -->
        </div>
      </div>
    </div>

    <div id="supplier-orders" class="page">
      <h2 class="text-2xl font-bold mb-4">Supplier Orders</h2>
      <div id="supplier-orders-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Supplier orders will be loaded here -->
      </div>
      <p class="text-sm text-gray-500 mt-4">Orders are created by the main user interface (not shown here) when stock is low.</p>
    </div>

    <div id="users" class="page">
      <h2 class="text-2xl font-bold mb-4">Manage Users</h2>
      <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-bold mb-3">Add New User Record (for Role Assignment)</h3>
        <input type="email" id="new-user-email" placeholder="New User Email" class="border px-3 py-2 rounded mb-2 w-full">
        <select id="new-user-role" class="border px-3 py-2 rounded mb-4 w-full">
          <option value="customer">Customer</option>
          <option value="manager">Manager</option>
          <option value="assistant">Shop Assistant</option>
        </select>
        <button id="add-user" class="bg-indigo-600 text-white px-4 py-2 rounded shadow-md hover:bg-indigo-700">Add User Record</button>
        <p class="text-xs mt-2 text-red-500">Note: This only sets the role. You must create the Firebase Auth user manually.</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-bold mb-3">Current Users (Records)</h3>
        <div id="users-list"></div>
      </div>
    </div>
  </main>
</div>

<div id="product-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto"> 
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-bold text-gray-800">Add / Edit Product</h3>
      <button id="product-modal-close" class="text-gray-600 hover:text-gray-900">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
      <input type="hidden" id="product-id-hidden">
    </div>
    <div class="space-y-4">
      <input type="text" id="product-name" placeholder="Product Name" class="w-full px-4 py-2 border rounded-lg">
      <select id="product-category" class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Category</option>
        <option value="Fruits">Fruits</option>
        <option value="Vegetables">Vegetables</option>
        <option value="Beverages">Beverages</option>
        <option value="Snacks">Snacks</option>
        <option value="Dairy">Dairy</option>
        <option value="Meat">Meat</option>
      </select>
      <input type="number" id="product-stock" placeholder="Stock (e.g. 50)" class="w-full px-4 py-2 border rounded-lg">
      <select id="product-unit" class="w-full px-4 py-2 border rounded-lg">
        <option value="">Select Unit</option>
        <option value="kg">kg</option>
        <option value="g">g</option>
        <option value="liter">liter</option>
        <option value="unit">unit</option>
      </select>
      <input type="number" step="0.01" id="product-price" placeholder="Price (e.g. 12.50)" class="w-full px-4 py-2 border rounded-lg">
      <input type="text" id="product-discount" placeholder="Discount Text (e.g. 10% OFF)" class="w-full px-4 py-2 border rounded-lg">
      <input type="number" step="0.1" id="product-rating" placeholder="Rating (0-5)" min="0" max="5" class="w-full px-4 py-2 border rounded-lg">
      <input type="file" id="product-image" accept="image/*" class="w-full px-4 py-2 border rounded-lg">
    </div>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="product-modal-cancel" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Cancel</button>
      <button id="product-modal-save" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Save</button>
      <button id="product-modal-delete" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 hidden">Delete</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  
  // üõë User's Firebase Configuration 
  const firebaseConfig = {
    apiKey: "AIzaSyDWH3LoCvRmTUMthsUsIA0MBiqZ4NmFyco",
    authDomain: "ecome-72c36.firebaseapp.com",
    projectId: "ecome-72c36",
    storageBucket: "ecome-72c36.appspot.com",
    messagingSenderId: "880319220349",
    appId: "1:880319220349:web:4af4666ec90587a23dbf14",
  };
  
  // üõë User's Cloudinary Credentials
  const cloudName='dxvjpkrzf';
  const uploadPreset='grocery_products';

  // Initialize Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  } else {
    firebase.app(); // if already initialized, use that one
  }
  
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Enable debug mode
  const DEBUG_MODE = true;

  // UI Elements
  const offcanvas = document.getElementById('offcanvasLoginRegister');
  const loginFormWrapper = document.getElementById('login-form-wrapper');
  const registerFormWrapper = document.getElementById('register-form-wrapper');
  const loggedInWrapper = document.getElementById('logged-in-wrapper');
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const userNameDisplay = document.getElementById('user-name-display');
  const logoutBtn = document.getElementById('logout-btn');
  const dashboardLogoutBtn = document.getElementById('dashboard-logout-btn');
  const forgotPasswordBtn = document.getElementById('forgot-password-btn');
  const generatePasswordBtn = document.getElementById('generate-password-btn');
  const mainDashboard = document.getElementById('main-dashboard-container');
  const sidebar = document.getElementById('sidebar');
  const navContainer = document.getElementById('nav-container');
  const pages = document.querySelectorAll('.page');

  let currentRole = '';
  let editingProductId = null;
  let allProducts = []; 
  let activeNavButton = null; 
  let dataLoaded = false; 

  // Debug logging function
  function debugLog(message, data = null) {
    if (DEBUG_MODE) {
      console.log(`[DEBUG] ${message}`, data || '');
    }
  }

  // --- Usability Fix: Notification System ---
  const showNotification = (message, type = 'success') => {
    let color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const notification = document.createElement('div');
    notification.className = `fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-3 rounded-lg text-white shadow-xl z-[100] ${color} transition-opacity duration-300`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
      notification.style.opacity = '0';
      setTimeout(() => notification.remove(), 300);
    }, 3000); 
  };

  // Debug toggle
  document.getElementById('debug-toggle')?.addEventListener('click', () => {
    const debugInfo = document.getElementById('debug-info');
    debugInfo.classList.toggle('hidden');
  });

  // --- Toggle between login/register ---
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      loginFormWrapper.classList.toggle('hidden', target === 'register-form-wrapper');
      registerFormWrapper.classList.toggle('hidden', target !== 'register-form-wrapper');
    });
  });

  // --- Auth State ---
  auth.onAuthStateChanged(async (user) => {
    debugLog('Auth state changed:', user ? 'User logged in' : 'User logged out');
    
    if (user) {
      // USER IS LOGGED IN
      try {
        debugLog('Fetching user data for:', user.uid);
        const doc = await db.collection('users').doc(user.uid).get();
        
        if (doc.exists) {
          const userData = doc.data();
          currentRole = userData.role;
          userNameDisplay.textContent = userData.name || user.email;
          debugLog('User role found:', currentRole);
        } else {
          currentRole = 'customer';
          userNameDisplay.textContent = user.email;
          debugLog('No user document, defaulting to customer role');
        }
      } catch (error) {
        console.error("Error fetching user role:", error);
        currentRole = 'customer';
        userNameDisplay.textContent = user.email;
      }
      
      // Show logged in state in offcanvas
      loginFormWrapper.classList.add('hidden');
      registerFormWrapper.classList.add('hidden');
      loggedInWrapper.classList.remove('hidden');
      
      // Hide offcanvas and show main dashboard
      offcanvas.classList.add('translate-x-full');
      mainDashboard.classList.remove('hidden');
      
      // üõë PREVENT LOOP/RELOAD: Only run initial setup and load data once
      if (!dataLoaded) {
        setupNav(currentRole);
        await loadAllData(); 
        dataLoaded = true; // Set flag after successful load
      }
      
    } else {
      // USER IS LOGGED OUT
      currentRole = ''; 
      dataLoaded = false; // Reset flag so next login runs data load
      
      // Show login form in offcanvas
      loggedInWrapper.classList.add('hidden');
      loginFormWrapper.classList.remove('hidden');
      registerFormWrapper.classList.add('hidden');
      
      // Show offcanvas and hide main dashboard
      offcanvas.classList.remove('translate-x-full');
      mainDashboard.classList.add('hidden');
    }
  });

  // --- Register ---
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('register-name').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const confirm = document.getElementById('register-password-confirm').value;
    const role = document.getElementById('register-role').value;
    const feedback = document.getElementById('password-feedback');

    if (password !== confirm) {
      feedback.textContent = 'Passwords do not match.';
      feedback.classList.add('text-red-500');
      return;
    }

    try {
      const userCred = await auth.createUserWithEmailAndPassword(email, password);
      await db.collection('users').doc(userCred.user.uid).set({ 
        name, 
        email, 
        role,
        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
      });
      feedback.textContent = 'Registration successful!';
      feedback.classList.add('text-green-500');
    } catch (err) {
      feedback.textContent = `Error: ${err.message}`;
      feedback.classList.add('text-red-500');
    }
  });

  // --- Login ---
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const role = document.getElementById('login-role').value;

    try {
      const userCred = await auth.signInWithEmailAndPassword(email, password);
      
      // Verify user has the correct role
      const userDoc = await db.collection('users').doc(userCred.user.uid).get();
      if (userDoc.exists && userDoc.data().role !== role) {
        await auth.signOut();
        showNotification(`Access denied. Your account is not registered as a ${role}.`, 'error');
        return;
      }
      
      showNotification('Login successful!', 'success');
    } catch (err) {
      showNotification(`Login failed: ${err.message}`, 'error');
    }
  });

  // --- Forgot Password ---
  forgotPasswordBtn.addEventListener('click', async () => {
    const email = document.getElementById('login-email').value;
    if (!email) {
      showNotification("Please enter your email address first.", 'error');
      return;
    }
    try {
      await auth.sendPasswordResetEmail(email);
      showNotification("Password reset email sent! Check your inbox.", 'success');
    } catch (err) {
      showNotification(`Error: ${err.message}`, 'error');
    }
  });

  // --- Logout ---
  logoutBtn.addEventListener('click', async () => {
    await auth.signOut();
    loginForm.reset();
    registerForm.reset();
  });
  
  dashboardLogoutBtn.addEventListener('click', async () => {
    await auth.signOut();
    loginForm.reset();
    registerForm.reset();
  });

  // --- Password Generator ---
  generatePasswordBtn.addEventListener('click', () => {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()";
    let password = "";
    for (let i = 0; i < 14; i++) password += chars.charAt(Math.floor(Math.random() * chars.length));
    document.getElementById('register-password').value = password;
    document.getElementById('password-feedback').textContent = "Password generated!";
    document.getElementById('password-feedback').classList.add('text-green-500');
  });

  // --- Offcanvas close button ---
  document.querySelector('.btn-close').addEventListener('click', () => {
    offcanvas.classList.add('translate-x-full');
  });

  // üõ°Ô∏è CRITICAL FIX: Proper data loading sequence
  const loadAllData = async () => {
    try {
      debugLog("Starting to load all data...");
      
      // First load products - this is critical for dashboard metrics
      await loadProducts();
      debugLog("Products loaded:", allProducts.length);
      
      // Always populate sales menu
      populateSaleProducts(); 

      // Now load dashboard metrics with the products data
      if(currentRole === 'manager'){
        debugLog("Loading manager dashboard...");
        await loadDashboardMetrics(); 
        await loadUsers(); 
        await loadSupplierOrders(); 
        await loadCustomerOrders();
        populateReportProducts();
      } else if (currentRole === 'assistant') {
        debugLog("Loading assistant dashboard...");
        await loadDashboardMetrics(false); 
        await loadCustomerOrders();
      } else {
        debugLog("Loading customer dashboard...");
        await loadDashboardMetrics(false);
        await loadCustomerOrders();
      }
      
      debugLog("All data loaded successfully");
    } catch (e) {
      console.error("Error in loadAllData:", e);
      showNotification("Failed to load dashboard data. Check console for details.", 'error');
    }
  }

  // --- Usability Fix: Active Link Highlighting ---
  const showPage=(page)=>{ 
    pages.forEach(p=>p.classList.remove('active')); 
    const el=document.getElementById(page.toLowerCase()); 
    if(el) {
      el.classList.add('active'); 
    }

    if (activeNavButton) {
      activeNavButton.classList.remove('bg-indigo-600', 'text-white');
      activeNavButton.classList.add('text-gray-700', 'hover:bg-gray-100');
    }

    const newActiveButton = Array.from(navContainer.querySelectorAll('button')).find(btn => 
      btn.textContent.trim().toLowerCase().includes(page.toLowerCase())
    );

    if (newActiveButton) {
      newActiveButton.classList.remove('text-gray-700', 'hover:bg-gray-100');
      newActiveButton.classList.add('bg-indigo-600', 'text-white');
      activeNavButton = newActiveButton;
    }
  };

  const roles={
    manager:['dashboard','products','reports','orders','supplier-orders','users'],
    assistant:['dashboard','sales','orders'],
    customer:['dashboard','orders']
  };
  
  const setupNav=(role)=>{
    navContainer.innerHTML='';
    const userPages = roles[role]; 
    
    userPages.forEach(item=>{
      const icon = getNavIcon(item); 
      const btn=document.createElement('button');
      btn.innerHTML=`<i data-lucide="${icon}" class="w-4 h-4 mr-2"></i> ${item.charAt(0).toUpperCase()+item.slice(1).replace('-', ' ')}`;
      btn.className='w-full text-left py-2 px-3 rounded flex items-center text-gray-700 hover:bg-gray-100 transition';
      
      btn.addEventListener('click',()=>{
        showPage(item);
        sidebar.classList.add('-translate-x-full'); 
      });
      navContainer.appendChild(btn);
    });
    
    lucide.createIcons();
    // Show dashboard by default, not the first item in the array
    showPage('dashboard');
  };
  
  const getNavIcon = (item) => {
    switch(item) {
      case 'dashboard': return 'layout-dashboard';
      case 'products': return 'shopping-bag';
      case 'reports': return 'bar-chart';
      case 'supplier-orders': return 'package';
      case 'users': return 'users';
      case 'sales': return 'receipt';
      case 'orders': return 'shopping-cart';
      default: return 'circle';
    }
  }

  // --- Dashboard Enhancement: Metrics and Chart ---
  const loadDashboardMetrics = async (isManager = true) => {
    try {
      debugLog("Loading dashboard metrics...");
      
      // Load all necessary data in parallel for better performance
      const [productsSnapshot, salesSnapshot, customersSnapshot, ordersSnapshot] = await Promise.all([
        db.collection('products').get(),
        db.collection('sales').get(),
        db.collection('customers').get(),
        db.collection('orders').get()
      ]);

      const totalProducts = productsSnapshot.size;
      const totalSales = salesSnapshot.size;
      const totalCustomers = customersSnapshot.size;
      const totalOrders = ordersSnapshot.size;
      
      let totalRevenue = 0;
      const salesData = salesSnapshot.docs.map(doc => {
        const data = doc.data();
        return {
          ...data,
          id: doc.id
        };
      });

      debugLog("Sales data:", salesData);
      debugLog("All products:", allProducts);

      // Calculate revenue
      for (const sale of salesData) {
        const product = allProducts.find(p => p.id === sale.productId);
        if (product) {
          totalRevenue += (sale.price || product.price) * sale.quantity;
        } else {
          console.warn("Product not found for sale:", sale.productId);
        }
      }

      const metricsContainer = document.getElementById('dashboard-metrics');
      
      // Create basic metrics for all users
      let metricsHtml = `
        ${createMetricCard('Products', totalProducts, 'shopping-bag', 'text-blue-500', 'bg-blue-100')}
        ${createMetricCard('Sales', totalSales, 'trending-up', 'text-green-500', 'bg-green-100')}
        ${createMetricCard('Revenue', `R ${totalRevenue.toFixed(2)}`, 'dollar-sign', 'text-purple-500', 'bg-purple-100')}
        ${createMetricCard('Customers', totalCustomers, 'users', 'text-orange-500', 'bg-orange-100')}
        ${createMetricCard('Orders', totalOrders, 'shopping-cart', 'text-indigo-500', 'bg-indigo-100')}
      `;

      // Add manager-specific metrics
      if (isManager) {
        const supplierOrdersSnapshot = await db.collection('supplierOrders').get();
        const pendingOrders = supplierOrdersSnapshot.docs.filter(doc => {
          const status = doc.data().status;
          return status !== 'Approved' && status !== 'Rejected';
        }).length;
        metricsHtml += createMetricCard('Pending Supplier Orders', pendingOrders, 'package', 'text-red-500', 'bg-red-100');
      }

      metricsContainer.innerHTML = metricsHtml;
      lucide.createIcons(); 
      
      // Render chart for managers
      const chartArea = document.getElementById('dashboard-chart-area');
      if (isManager && salesData.length > 0) {
        renderSalesChart(salesData);
      } else if (isManager) {
        chartArea.innerHTML = '<p class="text-gray-500">No sales data to display yet.</p>';
      } else {
        chartArea.innerHTML = '<p class="text-gray-500">Sales chart available for Managers only.</p>';
      }
      
      debugLog("Dashboard metrics loaded successfully");
    } catch (error) {
      console.error("Error loading dashboard metrics:", error);
      showNotification("Failed to load dashboard metrics", 'error');
    }
  }

  const renderSalesChart = (sales) => {
    const chartContainer = document.getElementById('dashboard-chart-area');
    if (!chartContainer) return;

    // Group sales by product
    const productSales = sales.reduce((acc, sale) => {
      acc[sale.productId] = (acc[sale.productId] || 0) + sale.quantity;
      return acc;
    }, {});

    // Get top 5 products by quantity sold
    const topSales = Object.entries(productSales)
      .sort(([, a], [, b]) => b - a)
      .slice(0, 5);

    if (topSales.length === 0) {
      chartContainer.innerHTML = '<p class="text-gray-500">No sales data to display yet.</p>';
      return;
    }

    const maxQuantity = topSales[0][1];
    let chartHtml = `<h3 class="text-xl font-bold mb-4">Top 5 Products by Quantity Sold</h3><div class="space-y-3">`;

    topSales.forEach(([productId, quantity]) => {
      const product = allProducts.find(p => p.id === productId);
      const name = product ? product.name : `Product ID: ${productId}`;
      const width = Math.round((quantity / maxQuantity) * 80); 

      chartHtml += `
        <div>
          <p class="text-sm font-medium mb-1">${name} (${quantity} sold)</p>
          <div class="h-4 bg-indigo-200 rounded-full">
            <div class="h-full bg-indigo-600 rounded-full" style="width: ${width}%;"></div>
          </div>
        </div>
      `;
    });

    chartHtml += `</div>`;
    chartContainer.innerHTML = chartHtml;
  }

  const createMetricCard = (title, value, icon, iconColor, bgColor) => {
    return `
      <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-500">${title}</p>
          <p class="text-3xl font-bold text-gray-900">${value}</p>
        </div>
        <div class="p-3 rounded-full ${bgColor}">
          <i data-lucide="${icon}" class="w-6 h-6 ${iconColor}"></i>
        </div>
      </div>
    `;
  }
  
  document.getElementById('sidebar-open-btn').addEventListener('click',()=>sidebar.classList.remove('-translate-x-full'));
  document.getElementById('sidebar-close-btn').addEventListener('click',()=>sidebar.classList.add('-translate-x-full'));

  const resetProductModal = () => {
    ['product-name','product-category','product-stock','product-unit','product-price','product-discount','product-rating'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('product-image').value = ''; 
    document.getElementById('product-id-hidden').value = '';
  };

  const productModal=document.getElementById('product-modal');
  document.getElementById('add-product-btn').addEventListener('click',()=>{ 
    editingProductId=null; 
    resetProductModal(); 
    productModal.classList.remove('hidden'); 
    document.getElementById('product-modal-delete').classList.add('hidden'); 
  });
  
  const closeProductModal=()=>{ 
    productModal.classList.add('hidden'); 
    resetProductModal(); 
    editingProductId=null;
  };
  
  document.getElementById('product-modal-close').addEventListener('click',closeProductModal);
  document.getElementById('product-modal-cancel').addEventListener('click',closeProductModal);

  const loadProducts=async()=>{
    try {
      const snapshot=await db.collection('products').get();
      allProducts=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
      debugLog("Loaded products:", allProducts.length);
      applyFiltersAndSort(); 
    } catch (error) {
      console.error("Error loading products:", error);
      throw error;
    }
  };

  // --- Filtering and Sorting Logic ---
  const applyFiltersAndSort = () => {
    const categoryFilter = document.getElementById('product-category-filter') ? document.getElementById('product-category-filter').value : 'All';
    const sortBy = document.getElementById('product-sort') ? document.getElementById('product-sort').value : 'name_asc';

    let filteredProducts = allProducts;

    // 1. Filter Logic
    if (categoryFilter !== 'All') {
      filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
    }

    // 2. Sorting Logic
    filteredProducts.sort((a, b) => {
      if (sortBy === 'name_asc') return a.name.localeCompare(b.name);
      if (sortBy === 'name_desc') return b.name.localeCompare(a.name);
      if (sortBy === 'price_asc') return a.price - b.price;
      if (sortBy === 'price_desc') return b.price - a.price;
      if (sortBy === 'stock_desc') return b.stock - a.stock;
      return 0;
    });

    renderProducts(filteredProducts);
  };

  const renderProducts=(products)=>{
    const tbody=document.getElementById('products-table-body');
    const grid=document.getElementById('productsGridAll');
    tbody.innerHTML=''; grid.innerHTML='';

    if (products.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">No products found.</td></tr>';
      grid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No products found.</p>';
      return;
    }
    
    products.forEach(p=>{
      const actionButtons = currentRole === 'manager' ? `
        <button class="text-indigo-600 hover:underline" onclick="editProduct('${p.id}')">Edit</button>
        <button class="text-red-600 hover:underline ml-2" onclick="deleteProduct('${p.id}')">Delete</button>
      ` : '';
      tbody.innerHTML+=`
        <tr class="border-b border-gray-200 hover:bg-gray-50">
          <td class="py-3 px-6">${p.name}</td>
          <td class="py-3 px-6">${p.category}</td>
          <td class="py-3 px-6">${p.stock}</td>
          <td class="py-3 px-6">R ${parseFloat(p.price).toFixed(2)}</td>
          <td class="py-3 px-6">${p.unit}</td>
          <td class="py-3 px-6">${p.rating}</td>
          <td class="py-3 px-6">${actionButtons}</td>
        </tr>
      `;
      
      // Product Grid View 
      grid.innerHTML+=`
        <div class="product-item border bg-white p-3 rounded-xl shadow-md relative">
          <span class="badge ${p.discount ? 'bg-indigo-500 text-white' : 'hidden'} absolute top-2 right-2 px-2 py-1 rounded text-xs font-semibold">${p.discount||''}</span>
          <figure><img src="${p.image||'https://via.placeholder.com/150'}" class="tab-image" alt="${p.name}"></figure>
          <h3 class="font-bold text-base mt-2">${p.name}</h3>
          <span class="qty text-gray-600 block text-sm">${p.stock} ${p.unit} in stock</span>
          <div class="flex items-center justify-between mt-1">
            <span class="rating block text-yellow-500 text-sm">‚≠ê ${p.rating}</span>
            <span class="price block text-lg font-bold text-indigo-600">R ${parseFloat(p.price).toFixed(2)}</span>
          </div>
        </div>
      `;
    });
    document.getElementById('add-product-btn').style.display = currentRole === 'manager' ? 'inline-block' : 'none';
  };

  window.editProduct=async(id)=>{
    if(currentRole !== 'manager') return; 
    editingProductId=id;
    document.getElementById('product-id-hidden').value = id; 
    try {
      const doc=await db.collection('products').doc(id).get();
      const p=doc.data();
      ['name','category','stock','unit','price','discount','rating'].forEach(f=>{
        document.getElementById(`product-${f}`).value=p[f]||'';
      });
      productModal.classList.remove('hidden');
      document.getElementById('product-modal-delete').classList.remove('hidden'); 
    } catch (error) {
      console.error("Error fetching product for edit:", error);
      showNotification('Failed to load product details.', 'error');
    }
  };

  window.deleteProduct=async(id)=>{
    if(currentRole !== 'manager') return; 
    if(!confirm('Are you sure you want to delete this product?')) return;
    try {
      await db.collection('products').doc(id).delete();
      await loadAllData();
      showNotification('Product deleted successfully!', 'success');
    } catch (error) {
      console.error("Error deleting product:", error);
      showNotification('Failed to delete product. Check permissions.', 'error');
    }
  };
  
  document.getElementById('product-modal-delete').addEventListener('click', async () => {
    if (editingProductId) {
      await deleteProduct(editingProductId);
      closeProductModal();
    }
  });

  document.getElementById('product-modal-save').addEventListener('click', async ()=>{
    if(currentRole !== 'manager') { showNotification('Access Denied', 'error'); return; } 
    const name=document.getElementById('product-name').value.trim();
    const category=document.getElementById('product-category').value;
    const stock=parseInt(document.getElementById('product-stock').value);
    const unit=document.getElementById('product-unit').value;
    const price=parseFloat(document.getElementById('product-price').value);
    const discount=document.getElementById('product-discount').value.trim();
    const rating=parseFloat(document.getElementById('product-rating').value);
    const imageInput=document.getElementById('product-image');
    
    if(!name||!category||isNaN(stock)||!unit||isNaN(price)||isNaN(rating)){ 
      showNotification('Please fill all fields (Stock, Price, Rating must be numbers).', 'error'); return;
    }
    
    const uploadImageToCloudinary=(file)=>{
      const formData=new FormData();
      formData.append('file',file);
      formData.append('upload_preset',uploadPreset);
      return fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`,{method:'POST',body:formData}).then(res=>res.json());
    };
    
    let imageUrl=null;
    if(imageInput.files.length){ 
      try {
        const res=await uploadImageToCloudinary(imageInput.files[0]); 
        imageUrl=res.secure_url; 
      } catch (e) {
        console.error("Cloudinary upload failed:", e);
        showNotification("Image upload failed. Check Cloudinary config.", 'error');
        return;
      }
    }
    
    const data={name,category,stock,unit,price,discount,rating, updatedAt: firebase.firestore.FieldValue.serverTimestamp()};
    if(imageUrl) data.image=imageUrl;
    
    try {
      if(editingProductId) {
        await db.collection('products').doc(editingProductId).update(data);
        showNotification('Product updated successfully!', 'success');
      }
      else {
        if(!data.image){ showNotification('Please select an image for a new product.', 'error'); return; }
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('products').add(data);
        showNotification('Product added successfully!', 'success');
      }
    } catch (error) {
      console.error("Error saving product data:", error);
      showNotification('Failed to save product. Check database permissions.', 'error');
      return;
    }
    
    closeProductModal(); 
    loadAllData();
  });

  const populateSaleProducts=()=>{
    const saleSelect=document.getElementById('sale-product');
    saleSelect.innerHTML='<option value="">-- Select Product --</option>';
    allProducts.forEach(p=>{
      const opt=document.createElement('option');
      opt.value=p.id; 
      opt.textContent=`${p.name} - R ${p.price} (${p.stock} in stock)`;
      saleSelect.appendChild(opt);
    });
  };

  document.getElementById('confirm-sale').addEventListener('click',async()=>{
    const productId=document.getElementById('sale-product').value;
    const quantity=parseInt(document.getElementById('sale-quantity').value);
    if(!productId||isNaN(quantity)||quantity<=0){ showNotification('Select product and quantity', 'error'); return; }
    
    const product=allProducts.find(p => p.id === productId);
    if(!product){ showNotification('Product not found in database.', 'error'); return; }
    
    if(quantity>product.stock){ showNotification(`Not enough stock. Only ${product.stock} ${product.unit} available.`, 'error'); return; }
    
    try {
      await db.runTransaction(async (transaction) => {
        const productRef = db.collection('products').doc(productId);
        const productDoc = await transaction.get(productRef);

        if (!productDoc.exists) {
          throw "Product does not exist!";
        }

        const newStock = productDoc.data().stock - quantity;
        if (newStock < 0) {
          throw "Stock is less than sale quantity after re-check.";
        }

        transaction.update(productRef, { stock: newStock });

        transaction.set(db.collection('sales').doc(), { 
          productId, 
          productName: product.name, 
          price: product.price, 
          quantity, 
          timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
          userId: auth.currentUser.uid 
        });
      });
      
      showNotification('Sale recorded successfully!', 'success'); 
      document.getElementById('sale-quantity').value='';
      loadAllData(); 
    } catch (e) {
      console.error("Transaction failed: ", e);
      showNotification(`Sale failed: ${e.message || e}`, 'error');
    }
  });

  document.getElementById('register-customer').addEventListener('click',async()=>{
    const name=document.getElementById('customer-name').value.trim();
    const phone=document.getElementById('customer-phone').value.trim();
    if(!name||!phone){ showNotification('Fill customer details', 'error'); return; }
    try {
      await db.collection('customers').add({ name, phone, registeredAt:firebase.firestore.FieldValue.serverTimestamp() });
      showNotification('Customer registered', 'success'); document.getElementById('customer-name').value=''; document.getElementById('customer-phone').value='';
      if (currentRole === 'manager') loadDashboardMetrics();
    } catch (error) {
      console.error("Error registering customer:", error);
      showNotification('Failed to register customer. Check permissions.', 'error');
    }
  });

  const populateReportProducts=()=>{
    const reportSelect=document.getElementById('report-product');
    reportSelect.innerHTML='<option value="">All Products</option>';
    allProducts.forEach(p=>{
      const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; reportSelect.appendChild(opt);
    });
  };

  document.getElementById('generate-report').addEventListener('click',async()=>{
    if(currentRole !== 'manager') { showNotification('Access Denied', 'error'); return; } 
    
    const productId=document.getElementById('report-product').value;
    const start=document.getElementById('report-start').value?new Date(document.getElementById('report-start').value):null;
    const end=document.getElementById('report-end').value?new Date(document.getElementById('report-end').value):null;
    
    if (end) end.setHours(23, 59, 59, 999);
    
    let query = db.collection('sales').orderBy('timestamp', 'desc');
    
    if(start) query = query.where('timestamp', '>=', start);
    if(end) query = query.where('timestamp', '<=', end);
    
    try {
      let snapshot=await query.get();
      let sales=snapshot.docs.map(d=>({id:d.id,...d.data()}));
      
      if(productId) sales=sales.filter(s=>s.productId===productId);
      
      const content=document.getElementById('reports-content');
      content.innerHTML='<h3 class="font-bold mb-4 text-xl">Generated Sales Report</h3>';
      if(sales.length===0){ content.innerHTML+='<p>No sales found for the selected criteria.</p>'; return; }
      
      let totalRevenue = 0;
      const salesHtml = sales.map(s=>{
        const product = allProducts.find(p => p.id === s.productId);
        const productName = product ? product.name : (s.productName || 'Unknown Product');
        const salePrice = s.price || (product ? product.price : 0); 
        const totalSale = salePrice * s.quantity;
        totalRevenue += totalSale;
        return `<p class="border-b pb-1 mb-1 text-sm">${productName} - Qty: ${s.quantity} x R${salePrice.toFixed(2)} = <span class="font-semibold text-indigo-600">R${totalSale.toFixed(2)}</span> (${s.timestamp.toDate().toLocaleString()})</p>`;
      }).join('');
      
      content.innerHTML += `
        <div class="mb-4 p-3 bg-indigo-50 text-indigo-800 font-bold rounded-lg shadow-inner">
          Total Revenue: R ${totalRevenue.toFixed(2)}
        </div>
        ${salesHtml}
      `;
    } catch (error) {
      console.error("Error generating report:", error);
      document.getElementById('reports-content').innerHTML = '<p class="text-red-500">Failed to generate report. Check database permissions.</p>';
    }
  });

  // --- Customer Orders Management ---
  const loadCustomerOrders = async () => {
    try {
      debugLog("Loading customer orders...");
      
      // Update debug info
      const debugContent = document.getElementById('debug-content');
      if (debugContent) {
        debugContent.innerHTML = `
          <div>Current Role: ${currentRole}</div>
          <div>User ID: ${auth.currentUser?.uid || 'Not logged in'}</div>
          <div>Loading orders...</div>
        `;
      }

      let query = db.collection('orders').orderBy('createdAt', 'desc');
      
      // If user is customer, only show their orders
      if (currentRole === 'customer') {
        if (!auth.currentUser) {
          debugLog("No authenticated user for customer orders");
          if (debugContent) {
            debugContent.innerHTML += '<div style="color: red;">No authenticated user</div>';
          }
          return;
        }
        query = query.where('userId', '==', auth.currentUser.uid);
        debugLog("Loading customer-specific orders for user:", auth.currentUser.uid);
      } else {
        debugLog("Loading all orders (manager/assistant view)");
      }
      
      const snapshot = await query.get();
      const ordersContainer = document.getElementById('customer-orders-content');
      if (!ordersContainer) {
        debugLog("Orders container not found");
        return;
      }

      ordersContainer.innerHTML = '';

      if (snapshot.empty) {
        ordersContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No orders found.</p>';
        debugLog("No orders found in database");
        if (debugContent) {
          debugContent.innerHTML += `<div>No orders found (searched ${snapshot.size} documents)</div>`;
        }
        return;
      }

      debugLog(`Found ${snapshot.size} orders`);
      if (debugContent) {
        debugContent.innerHTML += `<div>Found ${snapshot.size} orders</div>`;
      }

      snapshot.docs.forEach(doc => {
        const order = doc.data();
        const orderId = doc.id;
        
        const statusColors = {
          'pending': 'bg-yellow-100 text-yellow-800',
          'confirmed': 'bg-blue-100 text-blue-800',
          'preparing': 'bg-orange-100 text-orange-800',
          'out-for-delivery': 'bg-purple-100 text-purple-800',
          'delivered': 'bg-green-100 text-green-800',
          'cancelled': 'bg-red-100 text-red-800'
        };

        // Format date safely
        let orderDate = 'N/A';
        try {
          if (order.createdAt && order.createdAt.toDate) {
            orderDate = order.createdAt.toDate().toLocaleDateString();
          }
        } catch (e) {
          debugLog("Error formatting date:", e);
        }

        const orderHtml = `
          <div class="border rounded-lg p-4 bg-white shadow-sm">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-bold text-lg">Order #${orderId.substring(0, 8)}</h4>
                <p class="text-sm text-gray-600">Customer: ${order.customerInfo?.name || 'N/A'}</p>
                <p class="text-sm text-gray-600">Email: ${order.customerInfo?.email || 'N/A'}</p>
                <p class="text-sm text-gray-600">Phone: ${order.customerInfo?.phone || 'N/A'}</p>
              </div>
              <div class="text-right">
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[order.status] || 'bg-gray-100 text-gray-800'}">
                  ${order.status?.charAt(0).toUpperCase() + order.status?.slice(1) || 'Pending'}
                </span>
                <p class="text-sm text-gray-600 mt-1">${orderDate}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <h5 class="font-semibold mb-2">Items:</h5>
              ${order.items?.map(item => `
                <div class="flex justify-between text-sm py-1 border-b">
                  <span>${item.name} x ${item.quantity}</span>
                  <span>R ${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                </div>
              `).join('') || '<p class="text-sm text-gray-500">No items</p>'}
            </div>
            
            <div class="flex justify-between items-center border-t pt-3">
              <div>
                <strong class="text-lg">Total: R ${(order.totalAmount || 0).toFixed(2)}</strong>
              </div>
              ${currentRole !== 'customer' ? `
                <div class="flex gap-2">
                  <select class="border rounded px-2 py-1 text-sm order-status-select" data-order-id="${orderId}">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                    <option value="out-for-delivery" ${order.status === 'out-for-delivery' ? 'selected' : ''}>Out for Delivery</option>
                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
                </div>
              ` : ''}
            </div>
            
            ${order.deliveryAddress ? `
              <div class="mt-3 text-sm text-gray-600">
                <strong>Delivery Address:</strong> ${order.deliveryAddress.address}, ${order.deliveryAddress.city}, ${order.deliveryAddress.postalCode}
              </div>
            ` : ''}
          </div>
        `;

        ordersContainer.innerHTML += orderHtml;
      });

      // Add event listeners for status updates
      document.querySelectorAll('.order-status-select').forEach(select => {
        select.addEventListener('change', async (e) => {
          const orderId = e.target.getAttribute('data-order-id');
          const newStatus = e.target.value;
          
          try {
            await db.collection('orders').doc(orderId).update({
              status: newStatus,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`Order status updated to ${newStatus}`, 'success');
             // --- Customer Orders Management ---
  const loadCustomerOrders = async () => {
    try {
      debugLog("üöÄ Starting to load customer orders...");
      
      const debugContent = document.getElementById('debug-content');
      const statusFilter = document.getElementById('order-status-filter').value;
      
      if (debugContent) {
        debugContent.innerHTML = `
          <div><strong>Loading Orders...</strong></div>
          <div>Current Role: ${currentRole}</div>
          <div>User ID: ${auth.currentUser?.uid || 'Not logged in'}</div>
          <div>Status Filter: ${statusFilter}</div>
          <div>Timestamp: ${new Date().toLocaleTimeString()}</div>
        `;
      }

      // Build the query
      let query = db.collection('orders').orderBy('createdAt', 'desc');
      
      debugLog("Building query for role:", currentRole);
      
      // If user is customer, only show their orders
      if (currentRole === 'customer') {
        if (!auth.currentUser) {
          const errorMsg = "No authenticated user for customer orders";
          debugLog(errorMsg);
          if (debugContent) {
            debugContent.innerHTML += `<div style="color: red;">${errorMsg}</div>`;
          }
          showNotification("Please log in to view your orders", 'error');
          return;
        }
        query = query.where('userId', '==', auth.currentUser.uid);
        debugLog("Loading customer-specific orders for user:", auth.currentUser.uid);
      } else {
        debugLog("Loading ALL orders (manager/assistant view)");
      }
      
      // Apply status filter if not "all"
      if (statusFilter !== 'all') {
        query = query.where('status', '==', statusFilter);
        debugLog("Applied status filter:", statusFilter);
      }
      
      debugLog("Executing Firestore query...");
      const snapshot = await query.get();
      const ordersContainer = document.getElementById('customer-orders-content');
      const ordersCount = document.getElementById('orders-count');
      
      if (!ordersContainer) {
        debugLog("‚ùå Orders container not found in DOM");
        return;
      }

      ordersContainer.innerHTML = '';
      ordersCount.textContent = '0';

      if (snapshot.empty) {
        const noOrdersMsg = '<p class="text-gray-500 text-center py-8">No orders found matching your criteria.</p>';
        ordersContainer.innerHTML = noOrdersMsg;
        debugLog("üì≠ No orders found in database");
        if (debugContent) {
          debugContent.innerHTML += `<div>üì≠ No orders found (searched ${snapshot.size} documents)</div>`;
        }
        showNotification("No orders found", 'info');
        return;
      }

      debugLog(`‚úÖ Found ${snapshot.size} orders`);
      ordersCount.textContent = snapshot.size;
      
      if (debugContent) {
        debugContent.innerHTML += `<div style="color: green;">‚úÖ Found ${snapshot.size} orders</div>`;
      }

      // Process each order
      snapshot.docs.forEach((doc, index) => {
        const order = doc.data();
        const orderId = doc.id;
        
        debugLog(`Processing order ${index + 1}:`, { id: orderId, status: order.status });

        const statusColors = {
          'pending': 'bg-yellow-100 text-yellow-800',
          'confirmed': 'bg-blue-100 text-blue-800',
          'preparing': 'bg-orange-100 text-orange-800',
          'out-for-delivery': 'bg-purple-100 text-purple-800',
          'delivered': 'bg-green-100 text-green-800',
          'cancelled': 'bg-red-100 text-red-800'
        };

        // Format date safely
        let orderDate = 'Date not available';
        let orderTime = '';
        try {
          if (order.createdAt && order.createdAt.toDate) {
            const dateObj = order.createdAt.toDate();
            orderDate = dateObj.toLocaleDateString();
            orderTime = dateObj.toLocaleTimeString();
          } else if (order.createdAt && order.createdAt._seconds) {
            const dateObj = new Date(order.createdAt._seconds * 1000);
            orderDate = dateObj.toLocaleDateString();
            orderTime = dateObj.toLocaleTimeString();
          }
        } catch (e) {
          debugLog("Error formatting date:", e);
        }

        // Calculate item total safely
        const itemsTotal = order.items?.reduce((sum, item) => {
          return sum + ((item.price || 0) * (item.quantity || 1));
        }, 0) || 0;

        const orderHtml = `
          <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-3">
              <div class="flex-1">
                <h4 class="font-bold text-lg text-gray-800">Order #${orderId.substring(0, 8).toUpperCase()}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                  <div>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Customer:</span> ${order.customerInfo?.firstName || 'N/A'} ${order.customerInfo?.lastName || ''}
                    </p>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Email:</span> ${order.customerInfo?.email || 'N/A'}
                    </p>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Phone:</span> ${order.customerInfo?.phone || 'N/A'}
                    </p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Order Date:</span> ${orderDate}
                    </p>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Time:</span> ${orderTime}
                    </p>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Payment:</span> ${order.paymentMethod || 'N/A'}
                    </p>
                  </div>
                </div>
              </div>
              <div class="text-right ml-4">
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[order.status] || 'bg-gray-100 text-gray-800'}">
                  ${order.status?.charAt(0).toUpperCase() + order.status?.slice(1) || 'Pending'}
                </span>
                <p class="text-xs text-gray-500 mt-1">ID: ${orderId.substring(0, 8)}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <h5 class="font-semibold mb-2 text-gray-700">Order Items:</h5>
              <div class="space-y-2">
                ${order.items?.map(item => `
                  <div class="flex justify-between items-center text-sm py-2 px-3 bg-gray-50 rounded">
                    <div class="flex items-center">
                      <span class="font-medium">${item.name}</span>
                      <span class="text-gray-500 ml-2">x${item.quantity}</span>
                    </div>
                    <span class="font-semibold">R ${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                  </div>
                `).join('') || '<p class="text-sm text-gray-500 text-center py-2">No items in this order</p>'}
              </div>
            </div>
            
            <div class="flex justify-between items-center border-t pt-3">
              <div>
                <strong class="text-lg text-gray-800">Total: R ${(order.totalAmount || itemsTotal + (order.deliveryFee || 50)).toFixed(2)}</strong>
                <p class="text-sm text-gray-600">Items: R ${itemsTotal.toFixed(2)} + Delivery: R ${(order.deliveryFee || 50).toFixed(2)}</p>
              </div>
              ${currentRole !== 'customer' ? `
                <div class="flex gap-2">
                  <select class="border rounded px-3 py-2 text-sm order-status-select" data-order-id="${orderId}">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                    <option value="out-for-delivery" ${order.status === 'out-for-delivery' ? 'selected' : ''}>Out for Delivery</option>
                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
                </div>
              ` : ''}
            </div>
            
            ${order.deliveryAddress ? `
              <div class="mt-3 pt-3 border-t">
                <h6 class="font-semibold text-sm text-gray-700 mb-1">Delivery Address:</h6>
                <p class="text-sm text-gray-600">
                  ${order.deliveryAddress.address}, ${order.deliveryAddress.city}, ${order.deliveryAddress.postalCode}
                  ${order.deliveryAddress.instructions ? `<br><span class="text-xs text-gray-500">Instructions: ${order.deliveryAddress.instructions}</span>` : ''}
                </p>
              </div>
            ` : ''}
          </div>
        `;

        ordersContainer.innerHTML += orderHtml;
      });

      // Add event listeners for status updates
      document.querySelectorAll('.order-status-select').forEach(select => {
        select.addEventListener('change', async (e) => {
          const orderId = e.target.getAttribute('data-order-id');
          const newStatus = e.target.value;
          
          try {
            await db.collection('orders').doc(orderId).update({
              status: newStatus,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showNotification(`‚úÖ Order status updated to ${newStatus}`, 'success');
            loadCustomerOrders(); // Reload to show changes
          } catch (error) {
            console.error("Error updating order status:", error);
            showNotification('‚ùå Failed to update order status', 'error');
          }
        });
      });

      if (debugContent) {
        debugContent.innerHTML += `<div style="color: green;">‚úÖ Orders loaded successfully at ${new Date().toLocaleTimeString()}</div>`;
      }

      showNotification(`‚úÖ Loaded ${snapshot.size} orders`, 'success');

    } catch (error) {
      console.error("‚ùå Error loading customer orders:", error);
      const ordersContainer = document.getElementById('customer-orders-content');
      if (ordersContainer) {
        ordersContainer.innerHTML = `
          <div class="text-red-500 text-center py-8">
            <p class="text-lg font-semibold">Failed to load orders</p>
            <p class="text-sm mt-2">Error: ${error.message}</p>
            <p class="text-sm">Please check the console for details.</p>
            <button onclick="loadCustomerOrders()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
              Try Again
            </button>
          </div>
        `;
      }
      
      const debugContent = document.getElementById('debug-content');
      if (debugContent) {
        debugContent.innerHTML += `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
      }
      
      showNotification("‚ùå Failed to load orders", 'error');
    }
  };
          } catch (error) {
            console.error("Error updating order status:", error);
            showNotification('Failed to update order status', 'error');
          }
        });
      });

      if (debugContent) {
        debugContent.innerHTML += `<div style="color: green;">Orders loaded successfully</div>`;
      }

    } catch (error) {
      console.error("Error loading customer orders:", error);
      const ordersContainer = document.getElementById('customer-orders-content');
      if (ordersContainer) {
        ordersContainer.innerHTML = `
          <div class="text-red-500 text-center py-4">
            <p>Failed to load orders.</p>
            <p class="text-sm">Error: ${error.message}</p>
            <p class="text-sm">Please check the console for details.</p>
          </div>
        `;
      }
      
      const debugContent = document.getElementById('debug-content');
      if (debugContent) {
        debugContent.innerHTML += `<div style="color: red;">Error: ${error.message}</div>`;
      }
      
      showNotification("Failed to load orders", 'error');
    }
  };

  // Add event listener for order status filter
  document.addEventListener('DOMContentLoaded', () => {
    const statusFilter = document.getElementById('order-status-filter');
    if (statusFilter) {
      statusFilter.addEventListener('change', loadCustomerOrders);
    }
  });

  const loadUsers=async()=>{
    if(currentRole !== 'manager') return; 
    try {
      const snapshot=await db.collection('users').get();
      const list=document.getElementById('users-list'); list.innerHTML='';
      snapshot.docs.forEach(doc=>{
        const u=doc.data();
        if(u.email !== auth.currentUser.email) { 
          list.innerHTML+=`<div class="flex justify-between items-center p-3 border-b hover:bg-gray-50 rounded">${u.email} (${u.role}) <button class="text-red-600 hover:text-red-800" onclick="deleteUser('${doc.id}')">Delete</button></div>`;
        } else {
          list.innerHTML+=`<div class="flex justify-between items-center p-3 border-b bg-gray-50 rounded">${u.email} (${u.role}) <span class="text-gray-500 text-sm"> (You)</span></div>`;
        }
      });
    } catch (error) {
      console.error("Error loading users:", error);
      document.getElementById('users-list').innerHTML = '<p class="text-red-500">Failed to load users. Check permissions.</p>';
    }
  };
  
  document.getElementById('add-user').addEventListener('click',async()=>{
    if(currentRole !== 'manager') { showNotification('Access Denied', 'error'); return; } 
    const email=document.getElementById('new-user-email').value.trim();
    const role=document.getElementById('new-user-role').value;
    if(!email||!role){ showNotification('Fill details', 'error'); return; }
    try {
      await db.collection('users').add({ email, role, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      document.getElementById('new-user-email').value=''; 
      showNotification('User record added. You must create the Firebase Auth user manually.', 'success');
      loadUsers();
    } catch (error) {
      console.error("Error adding user:", error);
      showNotification('Failed to add user record. Check permissions.', 'error');
    }
  });
  
  window.deleteUser=async(id)=>{ 
    if(currentRole !== 'manager') return; 
    if(!confirm('Are you sure you want to delete this user record? This does NOT delete their Firebase Auth account.')) return;
    try {
      await db.collection('users').doc(id).delete(); 
      showNotification('User record deleted.', 'success');
      loadUsers(); 
    } catch (error) {
      console.error("Error deleting user:", error);
      showNotification('Failed to delete user record. Check permissions.', 'error');
    }
  };

  const loadSupplierOrders=async()=>{
    if(currentRole !== 'manager') return; 
    try {
      const snapshot=await db.collection('supplierOrders').orderBy('timestamp', 'desc').get();
      const container=document.getElementById('supplier-orders-content');
      container.innerHTML='';
      
      if (snapshot.empty) {
        container.innerHTML = '<p class="text-gray-500 col-span-full">No supplier orders found.</p>';
        return;
      }

      snapshot.docs.forEach(doc=>{
        const o=doc.data();
        let statusColor = 'text-gray-500';
        if (o.status === 'Approved') statusColor = 'text-green-600';
        if (o.status === 'Rejected') statusColor = 'text-red-600';

        container.innerHTML+=`<div class="border p-4 mb-2 rounded-xl shadow-md bg-white">
          <p class="font-bold text-lg">${o.productName || o.productId || 'Unknown Product'}</p>
          <p class="text-gray-600">Quantity: ${o.quantity}</p>
          <p>Status: <span class="font-semibold ${statusColor}">${o.status||'Pending'}</span></p>
          ${o.status!=='Approved' && o.status!=='Rejected' ? `
            <div class="mt-3 pt-3 border-t border-gray-100">
              <button class="bg-green-600 text-white px-3 py-1 rounded text-sm mr-2 hover:bg-green-700" onclick="approveOrder('${doc.id}')">Approve</button>
              <button class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700" onclick="rejectOrder('${doc.id}')">Reject</button>
          </div>` : ''}
        </div>`;
      });
    } catch (error) {
      console.error("Error loading orders:", error);
      document.getElementById('supplier-orders-content').innerHTML = '<p class="text-red-500">Failed to load orders. Check permissions.</p>';
    }
  };

  window.approveOrder=async(id)=>{ 
    if(currentRole !== 'manager') return; 
    try {
      await db.collection('supplierOrders').doc(id).update({ status:'Approved', approvedAt: firebase.firestore.FieldValue.serverTimestamp() }); 
      showNotification('Order approved!', 'success');
      loadSupplierOrders(); 
    } catch (error) {
      console.error("Error approving order:", error);
      showNotification('Failed to approve order. Check permissions.', 'error');
    }
  };
  
  window.rejectOrder=async(id)=>{ 
    if(currentRole !== 'manager') return; 
    try {
      await db.collection('supplierOrders').doc(id).update({ status:'Rejected', rejectedAt: firebase.firestore.FieldValue.serverTimestamp() }); 
      showNotification('Order rejected.', 'success');
      loadSupplierOrders(); 
    } catch (error) {
      console.error("Error rejecting order:", error);
      showNotification('Failed to reject order. Check permissions.', 'error');
    }
  };

  // Attach event listeners for filtering and sorting
  if (document.getElementById('product-category-filter')) {
    document.getElementById('product-category-filter').addEventListener('change', applyFiltersAndSort);
  }
  if (document.getElementById('product-sort')) {
    document.getElementById('product-sort').addEventListener('change', applyFiltersAndSort);
  }
  // Refresh orders button
  document.getElementById('refresh-orders')?.addEventListener('click', loadCustomerOrders);
  
  // Hide debug info
  document.getElementById('hide-debug')?.addEventListener('click', () => {
    document.getElementById('debug-info').classList.add('hidden');
  });
  
  // Order status filter
  document.getElementById('order-status-filter')?.addEventListener('change', loadCustomerOrders);
  lucide.createIcons();
});
</script>
</body>
</html>