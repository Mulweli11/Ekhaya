<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grocery Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: 'Inter', sans-serif; }
/* Ensure only the active page is displayed */
.page { display: none; }
.page.active { display: block; }
body::-webkit-scrollbar { display: none; }
body { -ms-overflow-style: none; scrollbar-width: none; }
.tab-image { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; }
/* Add a small transition for a smoother feel */
.product-item { transition: transform 0.2s; }
.product-item:hover { transform: translateY(-2px); }
</style>
</head>
<body class="bg-gray-100 text-gray-900">

<div id="loading-container" class="flex items-center justify-center min-h-screen bg-gray-100">
Â  <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
Â  Â  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  </svg>
</div>

<div id="login-page" class="flex flex-col items-center justify-center min-h-screen bg-gray-100 hidden">
Â  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6" id="login-title">Login</h2>
Â  Â  <div class="space-y-4">
Â  Â  Â  <input type="email" id="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  <input type="password" id="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  <select id="role-select" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  Â  <option value="manager">Manager</option>
Â  Â  Â  Â  <option value="assistant">Shop Assistant</option>
Â  Â  Â  </select>
Â  Â  Â  <button id="auth-btn" class="w-full py-3 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">Login</button>
Â  Â  Â  <p class="text-sm text-gray-500">Or <span id="toggle-auth" class="text-indigo-600 cursor-pointer">Register</span></p>
Â  Â  </div>
Â  </div>
</div>

<div id="main-dashboard-container" class="flex min-h-screen hidden">
Â  Â  <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 p-6 bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:flex lg:flex-col">
Â  Â  <div class="flex items-center justify-between lg:justify-start mb-10">
Â  Â  Â  <h1 class="text-2xl font-bold text-indigo-600">Grocery Admin</h1>
Â  Â  Â  <button id="sidebar-close-btn" class="p-2 text-gray-700 lg:hidden"><i data-lucide="x" class="w-6 h-6"></i></button>
Â  Â  </div>
Â  Â  <nav id="nav-container" class="space-y-2 flex-grow"></nav>
Â  Â  <div class="mt-8 pt-4 border-t border-gray-200">
Â  Â  Â  <button id="logout-btn" class="w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
Â  Â  Â  Â  <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
Â  Â  Â  </button>
Â  Â  </div>
Â  </aside>

Â  Â  <main class="flex-1 p-8 overflow-y-auto">
Â  Â  Â  Â  <button id="sidebar-open-btn" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-2 text-gray-700 bg-white rounded-lg shadow-md lg:hidden">
Â  Â  Â  <i data-lucide="menu" class="w-6 h-6"></i>
Â  Â  </button>

Â  Â  Â  Â  <div id="dashboard" class="page">
Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6">Dashboard</h2>
Â  Â  Â  Â  Â  Â  <div id="dashboard-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg" id="dashboard-chart-area">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="products" class="page">
Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800">Products</h2>
Â  Â  Â  Â  <button id="add-product-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Add New Product</button>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap items-center justify-between gap-4 mb-6 bg-white p-4 rounded-xl shadow-lg">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="product-category-filter" class="font-medium text-gray-700 mr-2">Filter by Category:</label>
Â  Â  Â  Â  Â  <select id="product-category-filter" class="border px-3 py-2 rounded-lg">
Â  Â  Â  Â  Â  Â  <option value="All">All Categories</option>
Â  Â  Â  Â  Â  Â  <option value="Fruits">Fruits</option>
Â  Â  Â  Â  Â  Â  <option value="Vegetables">Vegetables</option>
Â  Â  Â  Â  Â  Â  <option value="Beverages">Beverages</option>
Â  Â  Â  Â  Â  Â  <option value="Snacks">Snacks</option>
Â  Â  Â  Â  Â  Â  <option value="Dairy">Dairy</option>
Â  Â  Â  Â  Â  Â  <option value="Meat">Meat</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <label for="product-sort" class="font-medium text-gray-700 mr-2">Sort by:</label>
Â  Â  Â  Â  Â  <select id="product-sort" class="border px-3 py-2 rounded-lg">
Â  Â  Â  Â  Â  Â  <option value="name_asc">Name (A-Z)</option>
Â  Â  Â  Â  Â  Â  <option value="name_desc">Name (Z-A)</option>
Â  Â  Â  Â  Â  Â  <option value="price_asc">Price (Low to High)</option>
Â  Â  Â  Â  Â  Â  <option value="price_desc">Price (High to Low)</option>
Â  Â  Â  Â  Â  Â  <option value="stock_desc">Stock (High to Low)</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg mb-6 overflow-x-auto">
Â  Â  Â  Â  <table class="w-full text-left table-auto min-w-max">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-6">Product</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-6">Category</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-6">Stock</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-6">Price</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-6">Unit</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-6">Rating</th>
Â  Â  Â  Â  Â  Â  Â  <th class="py-3 px-6">Actions</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="products-table-body" class="text-gray-600 text-sm font-light"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="product-grid row grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4" id="productsGridAll"></div>
Â  Â  </div>

Â  Â  Â  Â  <div id="sales" class="page">
Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6">Process Sale</h2>
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
Â  Â  Â  Â  <label class="block font-medium mb-1">Product</label>
Â  Â  Â  Â  <select id="sale-product" class="w-full p-2 border rounded-lg mb-4"></select>
Â  Â  Â  Â  <label class="block font-medium mb-1">Quantity</label>
Â  Â  Â  Â  <input type="number" id="sale-quantity" class="w-full p-2 border rounded-lg mb-4" placeholder="Enter quantity to sell">
Â  Â  Â  Â  <button id="confirm-sale" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Confirm Sale</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg">
Â  Â  Â  Â  <h3 class="mt-1 text-xl font-bold mb-4">Walk-in Customer Registration</h3>
Â  Â  Â  Â  <input type="text" id="customer-name" placeholder="Name" class="w-full p-2 border rounded-lg mb-2">
Â  Â  Â  Â  <input type="text" id="customer-phone" placeholder="Phone" class="w-full p-2 border rounded-lg mb-4">
Â  Â  Â  Â  <button id="register-customer" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors">Register Customer</button>
Â  Â  Â  Â  <p class="text-xs mt-2 text-gray-500">This adds a record to the customers list for counting/marketing.</p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="reports" class="page">
Â  Â  Â  <h2 class="text-2xl font-bold mb-4">Sales Reports</h2>
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
Â  Â  Â  Â  <label class="block font-medium mb-1">Filter by Product:</label>
Â  Â  Â  Â  <select id="report-product" class="border px-3 py-2 rounded mb-4 w-full"></select>
Â  Â  Â  Â  <label class="block font-medium mb-1">Start Date:</label>
Â  Â  Â  Â  <input type="date" id="report-start" class="border px-3 py-2 rounded mb-4 w-full">
Â  Â  Â  Â  <label class="block font-medium mb-1">End Date:</label>
Â  Â  Â  Â  <input type="date" id="report-end" class="border px-3 py-2 rounded mb-4 w-full">
Â  Â  Â  Â  <button id="generate-report" class="bg-indigo-600 text-white px-4 py-2 rounded shadow-md hover:bg-indigo-700">Generate Report</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="reports-content" class="bg-white p-6 rounded-xl shadow-lg mt-6"></div>
Â  Â  </div>

Â  Â  Â  Â  <div id="orders" class="page">
Â  Â  Â  <h2 class="text-2xl font-bold mb-4">Supplier Orders</h2>
Â  Â  Â  <div id="orders-content" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
Â  Â  Â  <p class="text-sm text-gray-500 mt-4">Orders are created by the main user interface (not shown here) when stock is low.</p>
Â  Â  </div>

Â  Â  Â  Â  <div id="users" class="page">
Â  Â  Â  <h2 class="text-2xl font-bold mb-4">Manage Users</h2>
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
Â  Â  Â  Â  <h3 class="text-xl font-bold mb-3">Add New User Record (for Role Assignment)</h3>
Â  Â  Â  Â  <input type="email" id="new-user-email" placeholder="New User Email" class="border px-3 py-2 rounded mb-2 w-full">
Â  Â  Â  Â  <select id="new-user-role" class="border px-3 py-2 rounded mb-4 w-full">
Â  Â  Â  Â  Â  <option value="manager">Manager</option>
Â  Â  Â  Â  Â  <option value="assistant">Shop Assistant</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <button id="add-user" class="bg-indigo-600 text-white px-4 py-2 rounded shadow-md hover:bg-indigo-700">Add User Record</button>
Â  Â  Â  Â  <p class="text-xs mt-2 text-red-500">Note: This only sets the role. You must create the Firebase Auth user manually.</p>
Â  Â  Â  </div>
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg">
Â  Â  Â  Â  <h3 class="text-xl font-bold mb-3">Current Users (Records)</h3>
Â  Â  Â  Â  <div id="users-list"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </main>
</div>

<div id="product-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
Â  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto"> 
Â  Â  <div class="flex items-center justify-between mb-4">
Â  Â  Â  <h3 class="text-xl font-bold text-gray-800">Add / Edit Product</h3>
Â  Â  Â  <button id="product-modal-close" class="text-gray-600 hover:text-gray-900">
Â  Â  Â  Â  <i data-lucide="x" class="w-6 h-6"></i>
Â  Â  Â  </button>
Â  Â  Â  <input type="hidden" id="product-id-hidden">
Â  Â  </div>
Â  Â  <div class="space-y-4">
Â  Â  Â  <input type="text" id="product-name" placeholder="Product Name" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  <select id="product-category" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  Â  <option value="">Select Category</option>
Â  Â  Â  Â  <option value="Fruits">Fruits</option>
Â  Â  Â  Â  <option value="Vegetables">Vegetables</option>
Â  Â  Â  Â  <option value="Beverages">Beverages</option>
Â  Â  Â  Â  <option value="Snacks">Snacks</option>
Â  Â  Â  Â  <option value="Dairy">Dairy</option>
Â  Â  Â  Â  <option value="Meat">Meat</option>
Â  Â  Â  </select>
Â  Â  Â  <input type="number" id="product-stock" placeholder="Stock (e.g. 50)" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  <select id="product-unit" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  Â  <option value="">Select Unit</option>
Â  Â  Â  Â  <option value="kg">kg</option>
Â  Â  Â  Â  <option value="g">g</option>
Â  Â  Â  Â  <option value="liter">liter</option>
Â  Â  Â  Â  <option value="unit">unit</option>
Â  Â  Â  </select>
Â  Â  Â  <input type="number" step="0.01" id="product-price" placeholder="Price (e.g. 12.50)" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  <input type="text" id="product-discount" placeholder="Discount Text (e.g. 10% OFF)" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  <input type="number" step="0.1" id="product-rating" placeholder="Rating (0-5)" min="0" max="5" class="w-full px-4 py-2 border rounded-lg">
Â  Â  Â  <input type="file" id="product-image" accept="image/*" class="w-full px-4 py-2 border rounded-lg">
Â  Â  </div>
Â  Â  <div class="mt-6 flex justify-end space-x-3">
Â  Â  Â  <button id="product-modal-cancel" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Cancel</button>
Â  Â  Â  <button id="product-modal-save" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Save</button>
Â  Â  Â  <button id="product-modal-delete" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 hidden">Delete</button>
Â  Â  </div>
Â  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
Â  
Â  // ğŸ›‘ User's Firebase Configuration 
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyDWH3LoCvRmTUMthsUsIA0MBiqZ4NmFyco",
Â  Â  authDomain: "ecome-72c36.firebaseapp.com",
Â  Â  projectId: "ecome-72c36",
Â  Â  storageBucket: "ecome-72c36.appspot.com",
Â  Â  messagingSenderId: "880319220349",
Â  Â  appId: "1:880319220349:web:4af4666ec90587a23dbf14",
Â  };
Â  
Â  // ğŸ›‘ User's Cloudinary Credentials
Â  const cloudName='dxvjpkrzf';
Â  const uploadPreset='grocery_products';

Â  firebase.initializeApp(firebaseConfig);
Â  const auth = firebase.auth();
Â  const db = firebase.firestore();

Â  const loading = document.getElementById('loading-container');
Â  const loginPage = document.getElementById('login-page');
Â  const mainDashboard = document.getElementById('main-dashboard-container');
Â  const authBtn = document.getElementById('auth-btn');
Â  const toggleAuth = document.getElementById('toggle-auth');
Â  const loginTitle = document.getElementById('login-title');
Â  const sidebar=document.getElementById('sidebar');
Â  const navContainer=document.getElementById('nav-container');
Â  const pages=document.querySelectorAll('.page');

Â  let isRegister = false;
Â  let currentRole = '';
Â  let editingProductId = null;
Â  let allProducts = []; 
Â  let activeNavButton = null; 
Â  // ğŸ’¡ CRITICAL FIX: Flag to prevent data reloading on auth state change
Â  let dataLoaded = false; 

Â  // --- Usability Fix: Notification System ---
Â  const showNotification = (message, type = 'success') => {
Â  Â  let color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
Â  Â  const notification = document.createElement('div');
Â  Â  notification.className = `fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-3 rounded-lg text-white shadow-xl z-[100] ${color} transition-opacity duration-300`;
Â  Â  notification.textContent = message;
Â  Â  document.body.appendChild(notification);
Â  Â  setTimeout(() => {
Â  Â  Â  notification.style.opacity = '0';
Â  Â  Â  setTimeout(() => notification.remove(), 300);
Â  Â  }, 3000); 
Â  };

Â  const resetProductModal = () => {
Â  Â  ['product-name','product-category','product-stock','product-unit','product-price','product-discount','product-rating'].forEach(id=>document.getElementById(id).value='');
Â  Â  document.getElementById('product-image').value = ''; 
Â  Â  document.getElementById('product-id-hidden').value = '';
Â  };

Â  toggleAuth.addEventListener('click', () => {
Â  Â  isRegister = !isRegister;
Â  Â  loginTitle.innerText = isRegister ? 'Register' : 'Login';
Â  Â  authBtn.innerText = isRegister ? 'Register' : 'Login';
Â  Â  toggleAuth.innerText = isRegister ? 'Login' : 'Register'; 
Â  });

Â  authBtn.addEventListener('click', async ()=>{
Â  Â  const email=document.getElementById('email').value;
Â  Â  const password=document.getElementById('password').value;
Â  Â  const role=document.getElementById('role-select').value;
Â  Â  try{
Â  Â  Â  let userCredential;
Â  Â  Â  if(isRegister){
Â  Â  Â  Â  userCredential = await auth.createUserWithEmailAndPassword(email,password);
Â  Â  Â  Â  await db.collection('users').doc(userCredential.user.uid).set({ role, email });
Â  Â  Â  Â  currentRole = role; 
Â  Â  Â  Â  showNotification('Registration successful! Logging in...', 'success');
Â  Â  Â  } else {
Â  Â  Â  Â  userCredential = await auth.signInWithEmailAndPassword(email,password);
Â  Â  Â  }
Â  Â  }catch(err){ showNotification(err.message, 'error');}
Â  });

Â  // ğŸ”„ CRITICAL FIX: Auth State Listener with dataLoaded flag
Â  auth.onAuthStateChanged(async user=>{
Â  Â  loading.style.display='none';
Â  Â  if(user){
Â  Â  Â  // USER IS LOGGED IN
Â  Â  Â  loginPage.style.display='none';
Â  Â  Â  mainDashboard.classList.remove('hidden');
Â  Â  Â  
Â  Â  Â  if(!currentRole){
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const doc=await db.collection('users').doc(user.uid).get();
Â  Â  Â  Â  Â  currentRole=doc.exists?doc.data().role:'assistant'; 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error("Error fetching user role:", error);
Â  Â  Â  Â  Â  currentRole = 'assistant'; 
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  // ğŸ›‘ PREVENT LOOP/RELOAD: Only run initial setup and load data once
Â  Â  Â  if (!dataLoaded) {
Â  Â  Â  Â  setupNav(currentRole);
Â  Â  Â  Â  await loadAllData(); 
Â  Â  Â  Â  dataLoaded = true; // Set flag after successful load
Â  Â  Â  }
Â  Â  Â  
Â  Â  } else{
Â  Â  Â  // USER IS LOGGED OUT
Â  Â  Â  currentRole = ''; 
Â  Â  Â  dataLoaded = false; // Reset flag so next login runs data load
Â  Â  Â  loginPage.style.display='flex';
Â  Â  Â  mainDashboard.classList.add('hidden');
Â  Â  Â  isRegister = false;
Â  Â  Â  loginTitle.innerText = 'Login';
Â  Â  Â  authBtn.innerText = 'Login';
Â  Â  Â  toggleAuth.innerText = 'Register';
Â  Â  }
Â  });

Â  // ğŸ›¡ï¸ CRITICAL FIX: Added try...catch blocks for robustness
Â  const loadAllData = async () => {
Â  Â  try {
Â  Â  Â  await loadProducts();
Â  Â  } catch (e) {
Â  Â  Â  console.error("Error loading products:", e);
Â  Â  Â  showNotification("Failed to load products. Check permissions.", 'error');
Â  Â  }

Â  Â  // Always populate sales menu (even if products load failed, to be safe)
Â  Â  populateSaleProducts(); 

Â  Â  if(currentRole==='manager'){
Â  Â  Â  try { await loadDashboardMetrics(); } catch (e) { console.error("Metrics failed:", e); showNotification("Dashboard Metrics failed.", 'error'); }
Â  Â  Â  try { await loadUsers(); } catch (e) { console.error("Users failed:", e); showNotification("User management failed.", 'error'); }
Â  Â  Â  try { await loadSupplierOrders(); } catch (e) { console.error("Orders failed:", e); showNotification("Order loading failed.", 'error'); }
Â  Â  Â  populateReportProducts();
Â  Â  } else {
Â  Â  Â  try { await loadDashboardMetrics(false); } catch (e) { console.error("Assistant Metrics failed:", e); }
Â  Â  }
Â  }

Â  // --- Usability Fix: Active Link Highlighting ---
Â  const showPage=(page)=>{ 
Â  Â  pages.forEach(p=>p.classList.remove('active')); 
Â  Â  const el=document.getElementById(page.toLowerCase()); 
Â  Â  if(el)el.classList.add('active'); 

Â  Â  if (activeNavButton) {
Â  Â  Â  activeNavButton.classList.remove('bg-indigo-600', 'text-white');
Â  Â  Â  activeNavButton.classList.add('text-gray-700', 'hover:bg-gray-100');
Â  Â  }

Â  Â  const newActiveButton = Array.from(navContainer.querySelectorAll('button')).find(btn => 
Â  Â  Â  btn.textContent.trim().toLowerCase().includes(page.toLowerCase())
Â  Â  );

Â  Â  if (newActiveButton) {
Â  Â  Â  newActiveButton.classList.remove('text-gray-700', 'hover:bg-gray-100');
Â  Â  Â  newActiveButton.classList.add('bg-indigo-600', 'text-white');
Â  Â  Â  activeNavButton = newActiveButton;
Â  Â  }
Â  };

Â  const roles={
Â  Â  manager:['dashboard','products','reports','orders','users'],
Â  Â  assistant:['dashboard','sales']
Â  };
Â  
Â  const setupNav=(role)=>{
Â  Â  navContainer.innerHTML='';
Â  Â  const userPages = roles[role]; 
Â  Â  
Â  Â  userPages.forEach(item=>{
Â  Â  Â  const icon = getNavIcon(item); 
Â  Â  Â  const btn=document.createElement('button');
Â  Â  Â  btn.innerHTML=`<i data-lucide="${icon}" class="w-4 h-4 mr-2"></i> ${item.charAt(0).toUpperCase()+item.slice(1)}`;
Â  Â  Â  btn.className='w-full text-left py-2 px-3 rounded flex items-center text-gray-700 hover:bg-gray-100 transition';
Â  Â  Â  
Â  Â  Â  btn.addEventListener('click',()=>{
Â  Â  Â  Â  showPage(item);
Â  Â  Â  Â  sidebar.classList.add('-translate-x-full'); 
Â  Â  Â  });
Â  Â  Â  navContainer.appendChild(btn);
Â  Â  });
Â  Â  
Â  Â  lucide.createIcons();
Â  Â  showPage(userPages[0]);
Â  };
Â  
Â  const getNavIcon = (item) => {
Â  Â  switch(item) {
Â  Â  Â  case 'dashboard': return 'layout-dashboard';
Â  Â  Â  case 'products': return 'shopping-bag';
Â  Â  Â  case 'reports': return 'bar-chart';
Â  Â  Â  case 'orders': return 'package';
Â  Â  Â  case 'users': return 'users';
Â  Â  Â  case 'sales': return 'receipt';
Â  Â  Â  default: return 'circle';
Â  Â  }
Â  }

Â  // --- Dashboard Enhancement: Metrics and Chart ---
Â  const loadDashboardMetrics = async (isManager = true) => {
Â  Â  const productsSnapshot = await db.collection('products').get();
Â  Â  const salesSnapshot = await db.collection('sales').get();
Â  Â  const customersSnapshot = await db.collection('customers').get();
Â  Â  
Â  Â  const totalProducts = productsSnapshot.size;
Â  Â  const totalSales = salesSnapshot.size;
Â  Â  const totalCustomers = customersSnapshot.size;
Â  Â  
Â  Â  let totalRevenue = 0;
Â  Â  const salesData = salesSnapshot.docs.map(doc => doc.data());

Â  Â  for (const sale of salesData) {
Â  Â  Â  const product = allProducts.find(p => p.id === sale.productId);
Â  Â  Â  if (product) {
Â  Â  Â  Â  totalRevenue += (sale.price || product.price) * sale.quantity;
Â  Â  Â  }
Â  Â  }

Â  Â  const metricsContainer = document.getElementById('dashboard-metrics');
Â  Â  let metricsHtml = `
Â  Â  Â  ${createMetricCard('Products', totalProducts, 'shopping-bag', 'text-blue-500', 'bg-blue-100')}
Â  Â  Â  ${createMetricCard('Sales', totalSales, 'trending-up', 'text-green-500', 'bg-green-100')}
Â  Â  Â  ${createMetricCard('Revenue', `R ${totalRevenue.toFixed(2)}`, 'dollar-sign', 'text-purple-500', 'bg-purple-100')}
Â  Â  Â  ${createMetricCard('Customers', totalCustomers, 'users', 'text-orange-500', 'bg-orange-100')}
Â  Â  `;

Â  Â  if (isManager) {
Â  Â  Â  const ordersSnapshot = await db.collection('supplierOrders').get();
Â  Â  Â  const pendingOrders = ordersSnapshot.docs.filter(doc => doc.data().status !== 'Approved' && doc.data().status !== 'Rejected').length;
Â  Â  Â  metricsHtml += createMetricCard('Pending Orders', pendingOrders, 'package', 'text-red-500', 'bg-red-100');
Â  Â  }

Â  Â  metricsContainer.innerHTML = metricsHtml;
Â  Â  lucide.createIcons(); 
Â  Â  
Â  Â  const chartArea = document.getElementById('dashboard-chart-area');
Â  Â  if (isManager) {
Â  Â  Â  renderSalesChart(salesData);
Â  Â  } else {
Â  Â  Â  chartArea.innerHTML = '<p class="text-gray-500">Sales chart available for Managers only.</p>';
Â  Â  }
Â  }

Â  const renderSalesChart = (sales) => {
Â  Â  const chartContainer = document.getElementById('dashboard-chart-area');
Â  Â  if (!chartContainer) return;

Â  Â  const productSales = sales.reduce((acc, sale) => {
Â  Â  Â  acc[sale.productId] = (acc[sale.productId] || 0) + sale.quantity;
Â  Â  Â  return acc;
Â  Â  }, {});

Â  Â  const topSales = Object.entries(productSales)
Â  Â  Â  .sort(([, a], [, b]) => b - a)
Â  Â  Â  .slice(0, 5);

Â  Â  if (topSales.length === 0) {
Â  Â  Â  chartContainer.innerHTML = '<p class="text-gray-500">No sales data to display yet.</p>';
Â  Â  Â  return;
Â  Â  }

Â  Â  const maxQuantity = topSales[0][1];
Â  Â  let chartHtml = `<h3 class="text-xl font-bold mb-4">Top 5 Products by Quantity Sold</h3><div class="space-y-3">`;

Â  Â  topSales.forEach(([productId, quantity]) => {
Â  Â  Â  const product = allProducts.find(p => p.id === productId);
Â  Â  Â  const name = product ? product.name : `Product ID: ${productId}`;
Â  Â  Â  const width = Math.round((quantity / maxQuantity) * 80); 

Â  Â  Â  chartHtml += `
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <p class="text-sm font-medium mb-1">${name} (${quantity})</p>
Â  Â  Â  Â  Â  <div class="h-4 bg-indigo-200 rounded-full">
Â  Â  Â  Â  Â  Â  <div class="h-full bg-indigo-600 rounded-full" style="width: ${width}%;"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  });

Â  Â  chartHtml += `</div>`;
Â  Â  chartContainer.innerHTML = chartHtml;
Â  }
Â  // --- End Dashboard Enhancement ---

Â  const createMetricCard = (title, value, icon, iconColor, bgColor) => {
Â  Â  return `
Â  Â  Â  <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <p class="text-sm font-medium text-gray-500">${title}</p>
Â  Â  Â  Â  Â  <p class="text-3xl font-bold text-gray-900">${value}</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="p-3 rounded-full ${bgColor}">
Â  Â  Â  Â  Â  <i data-lucide="${icon}" class="w-6 h-6 ${iconColor}"></i>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  }
Â  
Â  document.getElementById('sidebar-open-btn').addEventListener('click',()=>sidebar.classList.remove('-translate-x-full'));
Â  document.getElementById('sidebar-close-btn').addEventListener('click',()=>sidebar.classList.add('-translate-x-full'));

Â  document.getElementById('logout-btn').addEventListener('click',()=>auth.signOut());

Â  const productModal=document.getElementById('product-modal');
Â  document.getElementById('add-product-btn').addEventListener('click',()=>{ 
Â  Â  editingProductId=null; 
Â  Â  resetProductModal(); 
Â  Â  productModal.classList.remove('hidden'); 
Â  Â  document.getElementById('product-modal-delete').classList.add('hidden'); 
Â  });
Â  
Â  const closeProductModal=()=>{ 
Â  Â  productModal.classList.add('hidden'); 
Â  Â  resetProductModal(); 
Â  Â  editingProductId=null;
Â  };
Â  
Â  document.getElementById('product-modal-close').addEventListener('click',closeProductModal);
Â  document.getElementById('product-modal-cancel').addEventListener('click',closeProductModal);

Â  const loadProducts=async()=>{
Â  Â  const snapshot=await db.collection('products').get();
Â  Â  allProducts=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
Â  Â  applyFiltersAndSort(); 
Â  };

Â  // --- NEW: Filtering and Sorting Logic ---
Â  const applyFiltersAndSort = () => {
Â  Â  const categoryFilter = document.getElementById('product-category-filter') ? document.getElementById('product-category-filter').value : 'All';
Â  Â  const sortBy = document.getElementById('product-sort') ? document.getElementById('product-sort').value : 'name_asc';

Â  Â  let filteredProducts = allProducts;

Â  Â  // 1. Filter Logic
Â  Â  if (categoryFilter !== 'All') {
Â  Â  Â  filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
Â  Â  }

Â  Â  // 2. Sorting Logic
Â  Â  filteredProducts.sort((a, b) => {
Â  Â  Â  if (sortBy === 'name_asc') return a.name.localeCompare(b.name);
Â  Â  Â  if (sortBy === 'name_desc') return b.name.localeCompare(a.name);
Â  Â  Â  if (sortBy === 'price_asc') return a.price - b.price;
Â  Â  Â  if (sortBy === 'price_desc') return b.price - a.price;
Â  Â  Â  if (sortBy === 'stock_desc') return b.stock - a.stock;
Â  Â  Â  return 0;
Â  Â  });

Â  Â  renderProducts(filteredProducts);
Â  };

Â  const renderProducts=(products)=>{
Â  Â  const tbody=document.getElementById('products-table-body');
Â  Â  const grid=document.getElementById('productsGridAll');
Â  Â  tbody.innerHTML=''; grid.innerHTML='';

Â  Â  if (products.length === 0) {
Â  Â  Â  tbody.innerHTML = '<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">No products found.</td></tr>';
Â  Â  Â  grid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No products found.</p>';
Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  products.forEach(p=>{
Â  Â  Â  const actionButtons = currentRole === 'manager' ? `
Â  Â  Â  Â  <button class="text-indigo-600 hover:underline" onclick="editProduct('${p.id}')">Edit</button>
Â  Â  Â  Â  <button class="text-red-600 hover:underline ml-2" onclick="deleteProduct('${p.id}')">Delete</button>
Â  Â  Â  ` : '';
Â  Â  Â  tbody.innerHTML+=`
Â  Â  Â  Â  <tr class="border-b border-gray-200 hover:bg-gray-50">
Â  Â  Â  Â  Â  <td class="py-3 px-6">${p.name}</td>
Â  Â  Â  Â  Â  <td class="py-3 px-6">${p.category}</td>
Â  Â  Â  Â  Â  <td class="py-3 px-6">${p.stock}</td>
Â  Â  Â  Â  Â  <td class="py-3 px-6">R ${parseFloat(p.price).toFixed(2)}</td>
Â  Â  Â  Â  Â  <td class="py-3 px-6">${p.unit}</td>
Â  Â  Â  Â  Â  <td class="py-3 px-6">${p.rating}</td>
Â  Â  Â  Â  Â  <td class="py-3 px-6">${actionButtons}</td>
Â  Â  Â  Â  </tr>
Â  Â  Â  `;
Â  Â  Â  
Â  Â  Â  // Product Grid View 
Â  Â  Â  grid.innerHTML+=`
Â  Â  Â  Â  <div class="product-item border bg-white p-3 rounded-xl shadow-md relative">
Â  Â  Â  Â  Â  <span class="badge ${p.discount ? 'bg-indigo-500 text-white' : 'hidden'} absolute top-2 right-2 px-2 py-1 rounded text-xs font-semibold">${p.discount||''}</span>
Â  Â  Â  Â  Â  <figure><img src="${p.image||'https://via.placeholder.com/150'}" class="tab-image" alt="${p.name}"></figure>
Â  Â  Â  Â  Â  <h3 class="font-bold text-base mt-2">${p.name}</h3>
Â  Â  Â  Â  Â  <span class="qty text-gray-600 block text-sm">${p.stock} ${p.unit} in stock</span>
Â  Â  Â  Â  Â  <div class="flex items-center justify-between mt-1">
Â  Â  Â  Â  Â  Â  <span class="rating block text-yellow-500 text-sm">â­ ${p.rating}</span>
Â  Â  Â  Â  Â  Â  <span class="price block text-lg font-bold text-indigo-600">R ${parseFloat(p.price).toFixed(2)}</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  });
Â  Â  document.getElementById('add-product-btn').style.display = currentRole === 'manager' ? 'inline-block' : 'none';
Â  };
Â  // --- End Filtering and Sorting Logic ---

Â  window.editProduct=async(id)=>{
Â  Â  if(currentRole !== 'manager') return; 
Â  Â  editingProductId=id;
Â  Â  document.getElementById('product-id-hidden').value = id; 
Â  Â  try {
Â  Â  Â  const doc=await db.collection('products').doc(id).get();
Â  Â  Â  const p=doc.data();
Â  Â  Â  ['name','category','stock','unit','price','discount','rating'].forEach(f=>{
Â  Â  Â  Â  document.getElementById(`product-${f}`).value=p[f]||'';
Â  Â  Â  });
Â  Â  Â  productModal.classList.remove('hidden');
Â  Â  Â  document.getElementById('product-modal-delete').classList.remove('hidden'); 
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error fetching product for edit:", error);
Â  Â  Â  showNotification('Failed to load product details.', 'error');
Â  Â  }
Â  };

Â  window.deleteProduct=async(id)=>{
Â  Â  if(currentRole !== 'manager') return; 
Â  Â  if(!confirm('Are you sure you want to delete this product?')) return;
Â  Â  try {
Â  Â  Â  await db.collection('products').doc(id).delete();
Â  Â  Â  await loadAllData();
Â  Â  Â  showNotification('Product deleted successfully!', 'success');
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error deleting product:", error);
Â  Â  Â  showNotification('Failed to delete product. Check permissions.', 'error');
Â  Â  }
Â  };
Â  
Â  document.getElementById('product-modal-delete').addEventListener('click', async () => {
Â  Â  if (editingProductId) {
Â  Â  Â  await deleteProduct(editingProductId);
Â  Â  Â  closeProductModal();
Â  Â  }
Â  });

Â  document.getElementById('product-modal-save').addEventListener('click', async ()=>{
Â  Â  if(currentRole !== 'manager') { showNotification('Access Denied', 'error'); return; } 
Â  Â  const name=document.getElementById('product-name').value.trim();
Â  Â  const category=document.getElementById('product-category').value;
Â  Â  const stock=parseInt(document.getElementById('product-stock').value);
Â  Â  const unit=document.getElementById('product-unit').value;
Â  Â  const price=parseFloat(document.getElementById('product-price').value);
Â  Â  const discount=document.getElementById('product-discount').value.trim();
Â  Â  const rating=parseFloat(document.getElementById('product-rating').value);
Â  Â  const imageInput=document.getElementById('product-image');
Â  Â  
Â  Â  if(!name||!category||isNaN(stock)||!unit||isNaN(price)||isNaN(rating)){ 
Â  Â  Â  showNotification('Please fill all fields (Stock, Price, Rating must be numbers).', 'error'); return;
Â  Â  }
Â  Â  
Â  Â  const uploadImageToCloudinary=(file)=>{
Â  Â  Â  const formData=new FormData();
Â  Â  Â  formData.append('file',file);
Â  Â  Â  formData.append('upload_preset',uploadPreset);
Â  Â  Â  return fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`,{method:'POST',body:formData}).then(res=>res.json());
Â  Â  };
Â  Â  
Â  Â  let imageUrl=null;
Â  Â  if(imageInput.files.length){ 
Â  Â  Â  try {
Â  Â  Â  Â  const res=await uploadImageToCloudinary(imageInput.files[0]); 
Â  Â  Â  Â  imageUrl=res.secure_url; 
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Cloudinary upload failed:", e);
Â  Â  Â  Â  showNotification("Image upload failed. Check Cloudinary config.", 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  const data={name,category,stock,unit,price,discount,rating, updatedAt: firebase.firestore.FieldValue.serverTimestamp()};
Â  Â  if(imageUrl) data.image=imageUrl;
Â  Â  
Â  Â  try {
Â  Â  Â  if(editingProductId) {
Â  Â  Â  Â  await db.collection('products').doc(editingProductId).update(data);
Â  Â  Â  Â  showNotification('Product updated successfully!', 'success');
Â  Â  Â  }
Â  Â  Â  else {
Â  Â  Â  Â  if(!data.image){ showNotification('Please select an image for a new product.', 'error'); return; }
Â  Â  Â  Â  data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
Â  Â  Â  Â  await db.collection('products').add(data);
Â  Â  Â  Â  showNotification('Product added successfully!', 'success');
Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error saving product data:", error);
Â  Â  Â  showNotification('Failed to save product. Check database permissions.', 'error');
Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  closeProductModal(); 
Â  Â  loadAllData();
Â  });

Â  const populateSaleProducts=()=>{
Â  Â  const saleSelect=document.getElementById('sale-product');
Â  Â  saleSelect.innerHTML='<option value="">-- Select Product --</option>';
Â  Â  allProducts.forEach(p=>{
Â  Â  Â  const opt=document.createElement('option');
Â  Â  Â  opt.value=p.id; 
Â  Â  Â  opt.textContent=`${p.name} - R ${p.price} (${p.stock} in stock)`;
Â  Â  Â  saleSelect.appendChild(opt);
Â  Â  });
Â  };

Â  document.getElementById('confirm-sale').addEventListener('click',async()=>{
Â  Â  const productId=document.getElementById('sale-product').value;
Â  Â  const quantity=parseInt(document.getElementById('sale-quantity').value);
Â  Â  if(!productId||isNaN(quantity)||quantity<=0){ showNotification('Select product and quantity', 'error'); return; }
Â  Â  
Â  Â  const product=allProducts.find(p => p.id === productId);
Â  Â  if(!product){ showNotification('Product not found in database.', 'error'); return; }
Â  Â  
Â  Â  if(quantity>product.stock){ showNotification(`Not enough stock. Only ${product.stock} ${product.unit} available.`, 'error'); return; }
Â  Â  
Â  Â  try {
Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  const productRef = db.collection('products').doc(productId);
Â  Â  Â  Â  const productDoc = await transaction.get(productRef);

Â  Â  Â  Â  if (!productDoc.exists) {
Â  Â  Â  Â  Â  throw "Product does not exist!";
Â  Â  Â  Â  }

Â  Â  Â  Â  const newStock = productDoc.data().stock - quantity;
Â  Â  Â  Â  if (newStock < 0) {
Â  Â  Â  Â  Â  throw "Stock is less than sale quantity after re-check.";
Â  Â  Â  Â  }

Â  Â  Â  Â  transaction.update(productRef, { stock: newStock });

Â  Â  Â  Â  transaction.set(db.collection('sales').doc(), { 
Â  Â  Â  Â  Â  productId, 
Â  Â  Â  Â  Â  productName: product.name, 
Â  Â  Â  Â  Â  price: product.price, 
Â  Â  Â  Â  Â  quantity, 
Â  Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
Â  Â  Â  Â  Â  userId: auth.currentUser.uid 
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  showNotification('Sale recorded successfully!', 'success'); 
Â  Â  Â  document.getElementById('sale-quantity').value='';
Â  Â  Â  loadAllData(); 
Â  Â  } catch (e) {
Â  Â  Â  console.error("Transaction failed: ", e);
Â  Â  Â  showNotification(`Sale failed: ${e.message || e}`, 'error');
Â  Â  }
Â  });

Â  document.getElementById('register-customer').addEventListener('click',async()=>{
Â  Â  const name=document.getElementById('customer-name').value.trim();
Â  Â  const phone=document.getElementById('customer-phone').value.trim();
Â  Â  if(!name||!phone){ showNotification('Fill customer details', 'error'); return; }
Â  Â  try {
Â  Â  Â  await db.collection('customers').add({ name, phone, registeredAt:firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  showNotification('Customer registered', 'success'); document.getElementById('customer-name').value=''; document.getElementById('customer-phone').value='';
Â  Â  Â  if (currentRole === 'manager') loadDashboardMetrics();
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error registering customer:", error);
Â  Â  Â  showNotification('Failed to register customer. Check permissions.', 'error');
Â  Â  }
Â  });

Â  const populateReportProducts=()=>{
Â  Â  const reportSelect=document.getElementById('report-product');
Â  Â  reportSelect.innerHTML='<option value="">All Products</option>';
Â  Â  allProducts.forEach(p=>{
Â  Â  Â  const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; reportSelect.appendChild(opt);
Â  Â  });
Â  };

Â  document.getElementById('generate-report').addEventListener('click',async()=>{
Â  Â  if(currentRole !== 'manager') { showNotification('Access Denied', 'error'); return; } 
Â  Â  
Â  Â  const productId=document.getElementById('report-product').value;
Â  Â  const start=document.getElementById('report-start').value?new Date(document.getElementById('report-start').value):null;
Â  Â  const end=document.getElementById('report-end').value?new Date(document.getElementById('report-end').value):null;
Â  Â  
Â  Â  if (end) end.setHours(23, 59, 59, 999);
Â  Â  
Â  Â  let query = db.collection('sales').orderBy('timestamp', 'desc');
Â  Â  
Â  Â  if(start) query = query.where('timestamp', '>=', start);
Â  Â  if(end) query = query.where('timestamp', '<=', end);
Â  Â  
Â  Â  try {
Â  Â  Â  let snapshot=await query.get();
Â  Â  Â  let sales=snapshot.docs.map(d=>({id:d.id,...d.data()}));
Â  Â  Â  
Â  Â  Â  if(productId) sales=sales.filter(s=>s.productId===productId);
Â  Â  Â  
Â  Â  Â  const content=document.getElementById('reports-content');
Â  Â  Â  content.innerHTML='<h3 class="font-bold mb-4 text-xl">Generated Sales Report</h3>';
Â  Â  Â  if(sales.length===0){ content.innerHTML+='<p>No sales found for the selected criteria.</p>'; return; }
Â  Â  Â  
Â  Â  Â  let totalRevenue = 0;
Â  Â  Â  const salesHtml = sales.map(s=>{
Â  Â  Â  Â  const product = allProducts.find(p => p.id === s.productId);
Â  Â  Â  Â  const productName = product ? product.name : (s.productName || 'Unknown Product');
Â  Â  Â  Â  const salePrice = s.price || (product ? product.price : 0); 
Â  Â  Â  Â  const totalSale = salePrice * s.quantity;
Â  Â  Â  Â  totalRevenue += totalSale;
Â  Â  Â  Â  return `<p class="border-b pb-1 mb-1 text-sm">${productName} - Qty: ${s.quantity} x R${salePrice.toFixed(2)} = <span class="font-semibold text-indigo-600">R${totalSale.toFixed(2)}</span> (${s.timestamp.toDate().toLocaleString()})</p>`;
Â  Â  Â  }).join('');
Â  Â  Â  
Â  Â  Â  content.innerHTML += `
Â  Â  Â  Â  <div class="mb-4 p-3 bg-indigo-50 text-indigo-800 font-bold rounded-lg shadow-inner">
Â  Â  Â  Â  Â  Total Revenue: R ${totalRevenue.toFixed(2)}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  ${salesHtml}
Â  Â  Â  `;
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error generating report:", error);
Â  Â  Â  document.getElementById('reports-content').innerHTML = '<p class="text-red-500">Failed to generate report. Check database permissions.</p>';
Â  Â  }
Â  });

Â  const loadUsers=async()=>{
Â  Â  if(currentRole !== 'manager') return; 
Â  Â  try {
Â  Â  Â  const snapshot=await db.collection('users').get();
Â  Â  Â  const list=document.getElementById('users-list'); list.innerHTML='';
Â  Â  Â  snapshot.docs.forEach(doc=>{
Â  Â  Â  Â  const u=doc.data();
Â  Â  Â  Â  if(u.email !== auth.currentUser.email) { 
Â  Â  Â  Â  Â  list.innerHTML+=`<div class="flex justify-between items-center p-3 border-b hover:bg-gray-50 rounded">${u.email} (${u.role}) <button class="text-red-600 hover:text-red-800" onclick="deleteUser('${doc.id}')">Delete</button></div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  list.innerHTML+=`<div class="flex justify-between items-center p-3 border-b bg-gray-50 rounded">${u.email} (${u.role}) <span class="text-gray-500 text-sm"> (You)</span></div>`;
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error loading users:", error);
Â  Â  Â  document.getElementById('users-list').innerHTML = '<p class="text-red-500">Failed to load users. Check permissions.</p>';
Â  Â  }
Â  };
Â  document.getElementById('add-user').addEventListener('click',async()=>{
Â  Â  if(currentRole !== 'manager') { showNotification('Access Denied', 'error'); return; } 
Â  Â  const email=document.getElementById('new-user-email').value.trim();
Â  Â  const role=document.getElementById('new-user-role').value;
Â  Â  if(!email||!role){ showNotification('Fill details', 'error'); return; }
Â  Â  try {
Â  Â  Â  await db.collection('users').add({ email, role, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  document.getElementById('new-user-email').value=''; 
Â  Â  Â  showNotification('User record added. You must create the Firebase Auth user manually.', 'success');
Â  Â  Â  loadUsers();
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error adding user:", error);
Â  Â  Â  showNotification('Failed to add user record. Check permissions.', 'error');
Â  Â  }
Â  });
Â  window.deleteUser=async(id)=>{ 
Â  Â  if(currentRole !== 'manager') return; 
Â  Â  if(!confirm('Are you sure you want to delete this user record? This does NOT delete their Firebase Auth account.')) return;
Â  Â  try {
Â  Â  Â  await db.collection('users').doc(id).delete(); 
Â  Â  Â  showNotification('User record deleted.', 'success');
Â  Â  Â  loadUsers(); 
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error deleting user:", error);
Â  Â  Â  showNotification('Failed to delete user record. Check permissions.', 'error');
Â  Â  }
Â  };

Â  const loadSupplierOrders=async()=>{
Â  Â  if(currentRole !== 'manager') return; 
Â  Â  try {
Â  Â  Â  const snapshot=await db.collection('supplierOrders').orderBy('timestamp', 'desc').get();
Â  Â  Â  const container=document.getElementById('orders-content');
Â  Â  Â  container.innerHTML='';
Â  Â  Â  
Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  container.innerHTML = '<p class="text-gray-500 col-span-full">No supplier orders found.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  snapshot.docs.forEach(doc=>{
Â  Â  Â  Â  const o=doc.data();
Â  Â  Â  Â  let statusColor = 'text-gray-500';
Â  Â  Â  Â  if (o.status === 'Approved') statusColor = 'text-green-600';
Â  Â  Â  Â  if (o.status === 'Rejected') statusColor = 'text-red-600';

Â  Â  Â  Â  container.innerHTML+=`<div class="border p-4 mb-2 rounded-xl shadow-md bg-white">
Â  Â  Â  Â  Â  <p class="font-bold text-lg">${o.productName || o.productId || 'Unknown Product'}</p>
Â  Â  Â  Â  Â  <p class="text-gray-600">Quantity: ${o.quantity}</p>
Â  Â  Â  Â  Â  <p>Status: <span class="font-semibold ${statusColor}">${o.status||'Pending'}</span></p>
Â  Â  Â  Â  Â  ${o.status!=='Approved' && o.status!=='Rejected' ? `
Â  Â  Â  Â  Â  Â  <div class="mt-3 pt-3 border-t border-gray-100">
Â  Â  Â  Â  Â  Â  Â  <button class="bg-green-600 text-white px-3 py-1 rounded text-sm mr-2 hover:bg-green-700" onclick="approveOrder('${doc.id}')">Approve</button>
Â  Â  Â  Â  Â  Â  Â  <button class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700" onclick="rejectOrder('${doc.id}')">Reject</button>
Â  Â  Â  Â  Â  </div>` : ''}
Â  Â  Â  Â  </div>`;
Â  Â  Â  });
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error loading orders:", error);
Â  Â  Â  document.getElementById('orders-content').innerHTML = '<p class="text-red-500">Failed to load orders. Check permissions.</p>';
Â  Â  }
Â  };

Â  window.approveOrder=async(id)=>{ 
Â  Â  if(currentRole !== 'manager') return; 
Â  Â  try {
Â  Â  Â  await db.collection('supplierOrders').doc(id).update({ status:'Approved', approvedAt: firebase.firestore.FieldValue.serverTimestamp() }); 
Â  Â  Â  showNotification('Order approved!', 'success');
Â  Â  Â  loadSupplierOrders(); 
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error approving order:", error);
Â  Â  Â  showNotification('Failed to approve order. Check permissions.', 'error');
Â  Â  }
Â  };
Â  window.rejectOrder=async(id)=>{ 
Â  Â  if(currentRole !== 'manager') return; 
Â  Â  try {
Â  Â  Â  await db.collection('supplierOrders').doc(id).update({ status:'Rejected', rejectedAt: firebase.firestore.FieldValue.serverTimestamp() }); 
Â  Â  Â  showNotification('Order rejected.', 'success');
Â  Â  Â  loadSupplierOrders(); 
Â  Â  } catch (error) {
Â  Â  Â  console.error("Error rejecting order:", error);
Â  Â  Â  showNotification('Failed to reject order. Check permissions.', 'error');
Â  Â  }
Â  };

Â  // Attach event listeners for filtering and sorting
Â  Â  if (document.getElementById('product-category-filter')) {
Â  Â  Â  document.getElementById('product-category-filter').addEventListener('change', applyFiltersAndSort);
Â  Â  }
Â  Â  if (document.getElementById('product-sort')) {
Â  Â  Â  document.getElementById('product-sort').addEventListener('change', applyFiltersAndSort);
Â  Â  }

Â  lucide.createIcons();
});
</script>
</body>
</html>